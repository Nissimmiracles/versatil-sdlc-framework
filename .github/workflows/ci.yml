name: VERSATIL CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Maria-QA: Quality Assurance Pipeline
  quality-assurance:
    name: ğŸ§ª Maria-QA Quality Gates
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ” ESLint code analysis
      run: npm run lint --if-present

    - name: ğŸ—ï¸ TypeScript compilation check
      run: npm run type-check --if-present

    - name: ğŸ§ª Run unit tests
      run: npm test --if-present

    - name: ğŸ“Š Generate coverage report
      run: npm run test:coverage --if-present

    - name: ğŸ“¤ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.node-version == '18.x'
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: versatil-coverage

    - name: ğŸ”’ Security audit
      run: npm audit --audit-level moderate

    - name: âœ… VERSATIL validation
      run: npm run versatil:validate --if-present

  # Chrome MCP Testing Pipeline
  chrome-mcp-testing:
    name: ğŸŒ Chrome MCP Testing
    runs-on: ubuntu-latest
    needs: quality-assurance

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ­ Install Playwright browsers
      run: npx playwright install --with-deps

    - name: ğŸŒ Install Chrome MCP
      run: npm install -g @modelcontextprotocol/server-chrome

    - name: ğŸš€ Start test server
      run: |
        npm run build --if-present
        npm run start &
        sleep 10
      continue-on-error: true

    - name: ğŸ§ª Run Chrome MCP tests
      run: npm run maria:chrome-test --if-present

    - name: ğŸ‘ï¸ Visual regression tests
      run: npm run maria:visual --if-present

    - name: âš¡ Performance tests
      run: npm run maria:performance --if-present

    - name: â™¿ Accessibility tests
      run: npm run maria:accessibility --if-present

    - name: ğŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: chrome-mcp-results
        path: |
          test-results/
          playwright-report/
          screenshots/
        retention-days: 30

  # James-Frontend: Frontend Validation
  frontend-validation:
    name: ğŸ¨ James-Frontend Validation
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'frontend') || contains(github.event.head_commit.modified, 'src/') || contains(github.event.head_commit.modified, 'components/')

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ¨ Frontend linting
      run: npm run james:lint --if-present

    - name: ğŸ—ï¸ Build frontend
      run: npm run james:build --if-present

    - name: ğŸ“Š Bundle analysis
      run: npm run james:analyze --if-present

    - name: âš¡ Lighthouse CI
      run: npm run james:lighthouse --if-present

  # Marcus-Backend: Backend Validation
  backend-validation:
    name: âš™ï¸ Marcus-Backend Validation
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'backend') || contains(github.event.head_commit.modified, 'server/') || contains(github.event.head_commit.modified, 'api/')

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ”’ Security scan
      run: npm run marcus:security --if-present

    - name: ğŸ—„ï¸ Database tests
      run: npm run marcus:db-test --if-present
      env:
        DATABASE_URL: postgresql://test:test@localhost:5432/test

    - name: ğŸ”— API tests
      run: npm run marcus:api-test --if-present

  # Sarah-PM: Documentation Validation
  documentation-validation:
    name: ğŸ“‹ Sarah-PM Documentation
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'README.md') || contains(github.event.head_commit.modified, 'docs/')

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“š Validate documentation
      run: |
        # Check for broken links
        npm install -g markdown-link-check
        find . -name "*.md" -exec markdown-link-check {} \;

    - name: ğŸ“‹ Generate project report
      run: npm run sarah:report --if-present

  # Release Pipeline
  release:
    name: ğŸš€ Release Pipeline
    runs-on: ubuntu-latest
    needs: [quality-assurance, chrome-mcp-testing]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org/'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build package
      run: npm run build --if-present

    - name: ğŸ“‹ Generate release notes
      run: npm run sarah:changelog --if-present

    - name: ğŸ‰ Create GitHub release
      uses: actions/create-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: VERSATIL SDLC Framework ${{ github.ref }}
        body: |
          ğŸ¤– VERSATIL SDLC Framework Release

          AI-Native Development Lifecycle with BMAD Methodology

          ## What's New
          - See CHANGELOG.md for detailed changes

          ## Installation
          ```bash
          npm install -g versatil-sdlc-framework
          npx versatil-sdlc init
          ```

          ğŸ¤– Generated with VERSATIL SDLC Framework
        draft: false
        prerelease: false

  # Notification Pipeline
  notifications:
    name: ğŸ“¢ Build Notifications
    runs-on: ubuntu-latest
    needs: [quality-assurance, chrome-mcp-testing]
    if: always()

    steps:
    - name: ğŸ“Š Build Status Summary
      run: |
        echo "ğŸ§ª Quality Assurance: ${{ needs.quality-assurance.result }}"
        echo "ğŸŒ Chrome MCP Testing: ${{ needs.chrome-mcp-testing.result }}"

        if [ "${{ needs.quality-assurance.result }}" == "success" ] && [ "${{ needs.chrome-mcp-testing.result }}" == "success" ]; then
          echo "âœ… All VERSATIL quality gates passed!"
        else
          echo "âŒ Some quality gates failed - review required"
        fi