# GitHub Actions Workflow Template for pnpm
# Copy this template structure for all workflow jobs that need Node.js + pnpm

name: Example Workflow with pnpm

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  example-job:
    name: Example Job with pnpm Setup
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup pnpm (CRITICAL - Must come BEFORE Node.js setup)
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.0

      # Step 3: Setup Node.js with pnpm cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # or use matrix: ${{ matrix.node }}
          cache: 'pnpm'       # Changed from 'npm'

      # Step 4: Install dependencies with frozen lockfile
      - name: Install dependencies
        run: pnpm install --frozen-lockfile  # Changed from 'npm ci'

      # Step 5: Your build/test/deploy steps
      - name: Build
        run: pnpm build  # Can use 'pnpm build' or 'pnpm run build'

      - name: Test
        run: pnpm test  # Can use 'pnpm test' or 'pnpm run test'

# ==============================================================================
# MATRIX BUILD EXAMPLE
# ==============================================================================
  matrix-build-example:
    name: Test on ${{ matrix.os }} with Node ${{ matrix.node }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [18, 20]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

# ==============================================================================
# SPECIAL CASE: Publishing to npm Registry
# ==============================================================================
  publish-to-npm:
    name: Publish to npm Registry
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      # IMPORTANT: Use 'npm publish' NOT 'pnpm publish' for npm registry
      - name: Publish to npm
        run: npm publish  # KEEP 'npm publish' - it's the standard
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

# ==============================================================================
# PLAYWRIGHT EXAMPLE
# ==============================================================================
  playwright-tests:
    name: Playwright Tests with pnpm
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run Playwright tests
        run: pnpm exec playwright test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

# ==============================================================================
# COMMON PATTERNS
# ==============================================================================
# Pattern 1: Run any npm script
#   OLD: npm run <script>
#   NEW: pnpm <script> OR pnpm run <script> (both work)

# Pattern 2: Global tool execution
#   OLD: npx <tool>
#   NEW: pnpm exec <tool> OR pnpm dlx <tool>

# Pattern 3: Security audit
#   OLD: npm audit
#   NEW: pnpm audit

# Pattern 4: Clean cache
#   OLD: npm cache clean --force
#   NEW: pnpm store prune
