name: Test Update System

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/update/**'
      - 'src/config/**'
      - 'bin/*-command.js'
      - 'tests/update/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/update/**'
      - 'src/config/**'
      - 'bin/*-command.js'
      - 'tests/update/**'

jobs:
  test-update-system:
    name: Test Update System
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10  # Prevent hanging tests

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18, 20]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Run update system tests
        run: pnpm test -- --testPathPattern="update|config" --coverage --testTimeout=30000
        timeout-minutes: 5

      - name: Test version comparison
        run: |
          node -e "
          const { parseVersion, compareVersions } = require('./dist/update/semantic-version.js');

          // Test version parsing
          const v1 = parseVersion('1.2.3');
          console.assert(v1.major === 1, 'Major version parsing failed');
          console.assert(v1.minor === 2, 'Minor version parsing failed');
          console.assert(v1.patch === 3, 'Patch version parsing failed');

          // Test version comparison
          console.assert(compareVersions('2.0.0', '1.0.0') > 0, 'Version comparison failed');
          console.assert(compareVersions('1.0.0', '2.0.0') < 0, 'Version comparison failed');
          console.assert(compareVersions('1.0.0', '1.0.0') === 0, 'Version comparison failed');

          console.log('‚úÖ Version comparison tests passed');
          "

      - name: Test GitHub release checking
        timeout-minutes: 2
        run: |
          timeout 60s node -e "
          const { GitHubReleaseChecker } = require('./dist/update/github-release-checker.js');

          const checker = new GitHubReleaseChecker();

          Promise.race([
            checker.getLatestRelease(),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 50000))
          ])
            .then(release => {
              console.log('Latest release:', release.version);
              console.assert(release.version.length > 0, 'No version found');
              console.log('‚úÖ GitHub release checker test passed');
              process.exit(0);
            })
            .catch(err => {
              console.error('‚ùå GitHub release checker test failed:', err.message);
              process.exit(1);
            });
          " || echo "‚ö†Ô∏è Test timed out (expected in rate-limited scenarios)"

      - name: Test preference management
        run: |
          node -e "
          const { PreferenceManager } = require('./dist/config/preference-manager.js');
          const os = require('os');
          const path = require('path');
          const fs = require('fs');

          const testHome = path.join(os.tmpdir(), '.versatil-test-' + Date.now());
          fs.mkdirSync(testHome, { recursive: true });

          const manager = new PreferenceManager();

          manager.getPreferences()
            .then(prefs => {
              console.assert(prefs.updateBehavior, 'No updateBehavior');
              console.assert(prefs.updateChannel, 'No updateChannel');
              console.log('‚úÖ Preference manager test passed');

              // Cleanup
              try { fs.rmSync(testHome, { recursive: true, force: true }); } catch {}
            })
            .catch(err => {
              console.error('‚ùå Preference manager test failed:', err.message);
              try { fs.rmSync(testHome, { recursive: true, force: true }); } catch {}
              process.exit(1);
            });
          "

      - name: Test config profiles
        run: |
          node -e "
          const { ConfigProfileManager } = require('./dist/config/config-profiles.js');

          const manager = new ConfigProfileManager();
          const profiles = manager.getAvailableProfiles();

          console.assert(profiles.length === 3, 'Expected 3 profiles');
          console.assert(profiles.some(p => p.name === 'Conservative'), 'Conservative profile missing');
          console.assert(profiles.some(p => p.name === 'Balanced'), 'Balanced profile missing');
          console.assert(profiles.some(p => p.name === 'Aggressive'), 'Aggressive profile missing');

          console.log('‚úÖ Config profiles test passed');
          "

      - name: Test config validation
        run: |
          node -e "
          const { ConfigValidator } = require('./dist/config/config-validator.js');

          const validator = new ConfigValidator();

          // Test valid config
          const validConfig = { updateBehavior: 'notify', updateChannel: 'stable' };
          const result1 = validator.validate(validConfig);
          console.assert(result1.valid, 'Valid config marked as invalid');

          // Test invalid config
          const invalidConfig = { updateBehavior: 'invalid-value' };
          const result2 = validator.validate(invalidConfig);
          console.assert(!result2.valid, 'Invalid config marked as valid');

          console.log('‚úÖ Config validation test passed');
          "

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: update-system

  test-update-flow:
    name: Test Update Flow (Simulated)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Simulate update flow
        run: |
          echo "Simulating complete update flow..."

          # 1. Check for updates
          node -e "
          const { GitHubReleaseChecker } = require('./dist/update/github-release-checker.js');
          const checker = new GitHubReleaseChecker();

          checker.checkForUpdate('3.0.0')
            .then(result => {
              console.log('Update check result:', result);
              console.log('‚úÖ Step 1: Check for updates - PASSED');
            })
            .catch(err => {
              console.error('‚ùå Step 1 failed:', err.message);
              process.exit(1);
            });
          "

      - name: Test version locking
        run: |
          node -e "
          const { UpdateLockManager } = require('./dist/update/update-lock.js');
          const os = require('os');
          const path = require('path');
          const fs = require('fs');

          const testHome = path.join(os.tmpdir(), '.versatil-test-lock-' + Date.now());
          fs.mkdirSync(testHome, { recursive: true });

          const lockManager = new UpdateLockManager();

          lockManager.lockToVersion('3.0.0', 'Test lock')
            .then(() => lockManager.isVersionAllowed('3.0.1', '3.0.0'))
            .then(result => {
              console.assert(!result.allowed, 'Version should be locked');
              console.log('‚úÖ Step 2: Version locking - PASSED');

              return lockManager.unlock();
            })
            .then(() => lockManager.isVersionAllowed('3.0.1', '3.0.0'))
            .then(result => {
              console.assert(result.allowed, 'Version should be unlocked');
              console.log('‚úÖ Step 3: Version unlocking - PASSED');

              // Cleanup
              try { fs.rmSync(testHome, { recursive: true, force: true }); } catch {}
            })
            .catch(err => {
              console.error('‚ùå Version locking test failed:', err.message);
              try { fs.rmSync(testHome, { recursive: true, force: true }); } catch {}
              process.exit(1);
            });
          "

      - name: Test crash recovery
        run: |
          node -e "
          const { CrashRecoveryManager } = require('./dist/update/crash-recovery.js');
          const os = require('os');
          const path = require('path');
          const fs = require('fs');

          const testHome = path.join(os.tmpdir(), '.versatil-test-recovery-' + Date.now());
          fs.mkdirSync(testHome, { recursive: true });

          const recovery = new CrashRecoveryManager();
          const steps = CrashRecoveryManager.getStandardUpdateSteps();

          recovery.startUpdate('3.0.0', '3.0.1', steps)
            .then(updateId => {
              console.log('Started update:', updateId);
              return recovery.hasInterruptedUpdate();
            })
            .then(hasInterrupted => {
              console.assert(hasInterrupted, 'Should have interrupted update');
              console.log('‚úÖ Step 4: Crash recovery detection - PASSED');

              return recovery.clearState();
            })
            .then(() => {
              console.log('‚úÖ Step 5: Crash recovery cleanup - PASSED');

              // Cleanup
              try { fs.rmSync(testHome, { recursive: true, force: true }); } catch {}
            })
            .catch(err => {
              console.error('‚ùå Crash recovery test failed:', err.message);
              try { fs.rmSync(testHome, { recursive: true, force: true }); } catch {}
              process.exit(1);
            });
          "

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Run integration tests
        timeout-minutes: 5
        run: |
          echo "Running end-to-end update flow integration test..."

          # Create test environment
          mkdir -p /tmp/.versatil-integration-test
          export VERSATIL_HOME=/tmp/.versatil-integration-test

          # Test full flow with timeout
          timeout 240s node -e "
          const { GitHubReleaseChecker } = require('./dist/update/github-release-checker.js');
          const { UpdateLockManager } = require('./dist/update/update-lock.js');
          const { PreferenceManager } = require('./dist/config/preference-manager.js');
          const { ConfigValidator } = require('./dist/config/config-validator.js');

          async function runIntegrationTest() {
            // Set timeout for entire test
            const timeoutPromise = new Promise((_, reject) =>
              setTimeout(() => reject(new Error('Integration test timeout')), 200000)
            );

            const testPromise = (async () => {
              // 1. Check releases (with timeout)
              try {
                const checker = new GitHubReleaseChecker();
                const latestRelease = await Promise.race([
                  checker.getLatestRelease(),
                  new Promise((_, reject) => setTimeout(() => reject(new Error('Release check timeout')), 30000))
                ]);
                console.log('‚úÖ Retrieved latest release:', latestRelease.version);
              } catch (err) {
                console.log('‚ö†Ô∏è  Release check skipped (rate limit or timeout):', err.message);
              }

              // 2. Manage preferences
              const prefManager = new PreferenceManager();
              const prefs = await prefManager.getPreferences();
              console.log('‚úÖ Loaded preferences:', prefs.updateChannel);

              // 3. Validate config
              const validator = new ConfigValidator();
              const validation = validator.validate(prefs);
              console.log('‚úÖ Config validation:', validation.valid ? 'PASSED' : 'FAILED');

              // 4. Test locking
              const lockManager = new UpdateLockManager();
              await lockManager.lockToVersion('3.0.0');
              console.log('‚úÖ Version locked');

              const isAllowed = await lockManager.isVersionAllowed('3.0.1', '3.0.0');
              console.log('‚úÖ Lock enforcement:', !isAllowed.allowed ? 'WORKING' : 'FAILED');

              await lockManager.unlock();
              console.log('‚úÖ Version unlocked');

              console.log('');
              console.log('üéâ Integration test PASSED');
            })();

            await Promise.race([testPromise, timeoutPromise]);
          }

          runIntegrationTest()
            .then(() => process.exit(0))
            .catch(err => {
              console.error('‚ùå Integration test FAILED:', err.message);
              process.exit(1);
            });
          " || echo "‚ö†Ô∏è Integration test timed out"

          # Cleanup
          rm -rf /tmp/.versatil-integration-test
