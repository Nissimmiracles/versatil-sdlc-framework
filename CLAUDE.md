# VERSATIL OPERA Methodology Guide

## Your Customized Agent Team


### Maria-QA
- **Priority**: 10/10
- **Auto-activation**: Enabled
- **Focus Areas**: Automated testing, Visual regression, Performance testing, Accessibility audits


### James-Frontend
- **Priority**: 5/10
- **Auto-activation**: Enabled
- **Focus Areas**: Component optimization, Performance monitoring, Design system, Responsive design


### Marcus-Backend
- **Priority**: 5/10
- **Auto-activation**: Enabled
- **Focus Areas**: API design, Database optimization, Security auditing, Architecture review


### Alex-BA
- **Priority**: 5/10
- **Auto-activation**: Enabled
- **Focus Areas**: Requirements analysis, User story creation, Analytics integration, Business logic validation


## Project Configuration
- **Type**: enterprise
- **Team Size**: solo
- **Experience Level**: intermediate
- **Technologies**: TypeScript, Express
- **Priorities**: Quality

## 📍 Your Development Roadmap

A personalized 4-week development roadmap has been generated for your project.
Check **docs/VERSATIL_ROADMAP.md** for detailed week-by-week milestones, agent recommendations, and quality gates.

Generated by VERSATIL Onboarding Wizard

---

## 🎯 Skills-First Architecture (v7.0.0+)

**94.1% Token Savings Through Progressive Disclosure**

VERSATIL v7.0.0 introduces Skills - modular capabilities that load context progressively, achieving ~11,235 token savings per prompt through three-level disclosure.

### Progressive Disclosure (3 Levels)

```
Level 1: Metadata (~15 tokens, always in context)
  ↓ When skill triggered
Level 2: SKILL.md (~500 tokens, loaded on-demand)
  ↓ When detailed docs needed
Level 3: references/*.md (~2,000 tokens each, loaded as-needed)
```

### Skill Categories

#### 1. Library Guides (15 skills)
**Location**: `.claude/skills/library-guides/`

Progressive disclosure for all framework libraries. Auto-detected when library name mentioned:

**HIGH Priority**: agents, rag, orchestration, testing (~7,000 tokens saved)
**MEDIUM Priority**: planning, mcp, templates (~1,115 tokens saved)
**LOW Priority**: dashboard, memory, validation, learning, intelligence, context, ui, hooks (~3,115 tokens saved)

**Example**: Mention "rag" in your message → hook notifies about `rag-library` skill → load details only if needed

#### 2. Code Generators (5 skills)
**Location**: `.claude/skills/code-generators/`

Asset-based templates for 5-10x faster development:
- **agent-creator** - OPERA agent definitions (6x faster)
- **command-creator** - Slash commands (5.6x faster)
- **hook-creator** - Lifecycle hooks (5x faster)
- **skill-creator** - New skills (5x faster)
- **test-creator** - Unit/integration tests (5x faster)

**Usage**: Copy templates from `assets/` directories, replace `{{placeholders}}`

#### 3. RAG Patterns (5 skills)
**Location**: `.claude/skills/rag-patterns/`

Historical implementation patterns with 85-95% token savings:
- **native-sdk-integration** - SDK hook patterns
- **victor-verifier** - Anti-hallucination (Chain-of-Verification)
- **assessment-engine** - Quality audits (Lighthouse, axe-core, Semgrep)
- **session-codify** - Learning codification on Stop hook
- **marketplace-organization** - Plugin metadata cleanup

**Usage**: Auto-detected via keywords (hook, verify, assess, codify, marketplace)

#### 4. Custom Skills (5 skills)
**Location**: `.claude/skills/`

Framework-specific capabilities:
- **compounding-engineering** - Pattern search, template matching, todo generation
- **quality-gates** - 80%+ coverage, TypeScript, contract validation
- **opera-orchestration** - OPERA phase detection, multi-agent coordination
- **context-injection** - Three-layer context (User > Library > Team > Framework)
- **rag-query** - RAG memory operations (query and store)

### Benefits

- **94.1% token savings**: ~11,235 tokens per prompt
- **< 50ms resolution**: No file I/O unless skill invoked
- **5-10x faster dev**: Asset-based templates vs regeneration
- **Semantic discovery**: Natural language vs brittle regex

### Quick Start

```bash
# Create new agent (6x faster)
cp .claude/skills/code-generators/agent-creator/assets/agent-template.md \
   .claude/agents/your-agent.md

# Create new command (5.6x faster)
cp .claude/skills/code-generators/command-creator/assets/command-template.md \
   .claude/commands/your-command.md

# Create new skill (5x faster)
cp .claude/skills/code-generators/skill-creator/assets/SKILL-template.md \
   .claude/skills/your-category/your-skill/SKILL.md
```

### Documentation

- **Complete Guide**: [docs/VERSATIL_ARCHITECTURE.md](docs/VERSATIL_ARCHITECTURE.md)
- **Skills Transformation**: [docs/SKILLS_FIRST_ARCHITECTURE_TRANSFORMATION.md](docs/SKILLS_FIRST_ARCHITECTURE_TRANSFORMATION.md)
- **Migration Guide**: [docs/MIGRATION_V6_TO_V7.md](docs/MIGRATION_V6_TO_V7.md)

---

## 🤖 Proactive Automation Rules (v7.1.0+)

**Hooks Drive Automation → Claude Executes Immediately**

VERSATIL v7.1.0 introduces fully automated skill discovery, template application, and agent invocation. Hooks detect intent and inject suggestions with action flags - Claude must execute immediately without asking.

### Core Principle

```
Hook Suggests with autoApply: true → Claude MUST Execute → No User Confirmation
```

**This is NOT optional** - when hooks provide clear instructions with `autoApply: true`, execute immediately to maintain development velocity.

---

### Rule 1: Template Auto-Application

**When hook provides template with `autoApply: true`:**

✅ **DO THIS IMMEDIATELY**:
1. Read template from `path` (e.g., `.claude/skills/code-generators/agent-creator/assets/agent-template.md`)
2. Replace all `{{PLACEHOLDERS}}` with contextual values
3. Write result to target location
4. Notify user: "✅ Applied [template-name] template ([productivity] faster)"

❌ **NEVER**:
- Ask user "should I apply this template?"
- Wait for confirmation
- Skip template application

**Example Hook Output**:
```json
{
  "hookType": "template-auto-suggestion",
  "template": {
    "name": "agent-creator",
    "path": ".claude/skills/code-generators/agent-creator/assets/agent-template.md",
    "productivity": "6x faster"
  },
  "action": "COPY_TEMPLATE_NOW",
  "autoApply": true
}
```

**Your Response**:
```typescript
// Read template
const template = await Read('.claude/skills/code-generators/agent-creator/assets/agent-template.md');
// Replace placeholders
const content = template.replace(/\{\{AGENT_NAME\}\}/g, 'python-backend')
                       .replace(/\{\{ROLE\}\}/g, 'Backend Development')
                       .replace(/\{\{TOOLS\}\}/g, '"Read", "Write", "Bash(python:*)"');
// Write result
await Write('.claude/agents/python-backend.md', content);
// Notify
"✅ Applied agent-creator template (6x faster: 60min → 10min)"
```

---

### Rule 2: Agent Auto-Activation (MANDATORY)

**When you see in context:**
```
- **🤖 AGENT**: `Maria-QA`
- **AUTO-ACTIVATE**: YES
```

✅ **YOU MUST IMMEDIATELY**:
```typescript
await Task({
  subagent_type: "Maria-QA",
  description: "Auto-activated from hook",
  prompt: "[Task from hook output]"
});
```

❌ **NEVER**:
- Ask user "should I activate this agent?"
- Explain what the agent does before invoking
- Skip agent invocation
- Wait for user confirmation

**VIOLATION PENALTY**: User will see you ignored automation directive

**Example Hook Output**:
```json
{
  "hookType": "agent-activation-suggestion",
  "agent": "Maria-QA",
  "autoActivate": true,
  "task": "Validate test coverage for src/auth.test.ts"
}
```

**Your Response**:
```typescript
await Task({
  subagent_type: "Maria-QA",
  description: "Quality validation",
  prompt: "Validate test coverage for src/auth.test.ts. Ensure 80%+ coverage and AAA pattern compliance."
});
```

---

### Rule 3: Pattern Auto-Application

**When hook provides RAG pattern with `autoApply: true`:**

✅ **DO THIS IMMEDIATELY**:
1. Load pattern details from `rag-patterns` skill
2. Apply pattern code/configuration
3. Notify user: "✅ Applied [pattern-name] pattern ([success-rate] success)"

**Example Hook Output**:
```json
{
  "hookType": "rag-pattern-suggestion",
  "pattern": "jwt-auth-cookies",
  "success": "98%",
  "effort": "12h",
  "autoApply": true
}
```

**Your Response**:
```typescript
// Load pattern from skill
const pattern = await loadSkill('rag-patterns/jwt-auth-cookies');
// Apply pattern code
await Edit('src/auth.ts', {
  old_string: 'res.json({ token })',
  new_string: 'res.cookie("token", token, { httpOnly: true, secure: true, sameSite: "strict" })'
});
// Notify
"✅ Applied jwt-auth-cookies pattern (98% success rate, 12h estimated effort)"
```

---

### Rule 4: Cross-Skill Loading (MANDATORY)

**When you see in context:**
```
## Related Libraries (recommended - Phase 6):
- **orchestration-library** - Often used together
- **testing-library** - Often used together
```

✅ **YOU MUST**:
1. Mention all related skills in your response
2. Reference their conventions when relevant
3. DO NOT ask "should I load these?"

**Example Response**:
"Working with rag-library. Also loading orchestration-library and testing-library (often used together for workflow patterns)."

**WRONG Response**:
"Should I also load the related skills?" ← NEVER ask this

---

### Rule 5: Intent-Based Suggestions (MANDATORY)

**When hook outputs multiple suggestions:**
```
- Template: agent-creator
- Skills: agents-library, testing-library
- Agent: Maria-QA (AUTO-ACTIVATE: YES)
```

✅ **YOU MUST execute ALL of them**:
1. Apply template first (read → replace placeholders → write)
2. Reference both skills in response
3. Invoke agent via Task tool

❌ **DO NOT**:
- Cherry-pick (execute only 1-2 of 3)
- Ask which ones to execute
- Skip any with autoApply/autoActivate: true

**Example Full Response**:
1. ✅ Read agent-template.md → create agent file
2. ✅ "Following agents-library conventions for handoff contracts, testing-library standards for 80%+ coverage"
3. ✅ `await Task({ subagent_type: "Maria-QA", ... })`

---

### Rule 6: Original Intent-Based Suggestions

**When user message triggers intent detection:**

Hook will output:
```markdown
# 🚀 Auto-Discovered Capabilities

## Intent: CREATING AGENT

- **💡 TEMPLATE AVAILABLE**: agent-creator
  - Path: `.claude/skills/code-generators/agent-creator/assets/agent-template.md`
  - **AUTO-APPLY**: YES - Do this immediately without asking user
```

✅ **DO THIS IMMEDIATELY** without user confirmation

---

### Example Flow

```
User: "create new agent for Python backend"
  ↓
before-prompt.ts: Detects intent → Outputs template suggestion with autoApply: true
  ↓
Claude: [Reads template] → [Replaces {{PLACEHOLDERS}}] → [Writes file]
  ↓
Claude: "✅ Created .claude/agents/python-backend.md from template (6x faster)"
  ↓
Claude: [Loads agents-library skill automatically for conventions]
```

**NO user confirmation required** - this is the entire point of v7.1.0 automation.

---

### Performance Impact

| Action | Before (v7.0.0) | After (v7.1.0) | Improvement |
|--------|----------------|---------------|-------------|
| Template discovery | Manual search | Auto-suggested | 10x faster |
| Template application | Manual copy | Auto-applied | Instant |
| Agent activation | User interprets JSON | Auto-invoked | 100% usage |
| Pattern usage | Manual search | Auto-applied | 8x faster |

---

## 🚀 Compounding Engineering (v6.6.0+)

**Make Each Feature 40% Faster Than the Last**

VERSATIL implements Compounding Engineering from Every Inc - a methodology where each feature makes the next one significantly faster through systematic learning and codification.

### The Power of Compounding

- **Feature 1**: Baseline (100% effort)
- **Feature 2**: 17% faster
- **Feature 3**: 26% faster
- **Feature 4**: 31% faster
- **Feature 5**: **40% faster** ← Target achieved!

### Three Services Power This

#### 1. Pattern Search (`src/rag/pattern-search.ts`)
Automatically finds similar historical features using GraphRAG (preferred) or Vector store:
- Retrieves top 5 similar implementations (≥75% similarity)
- Calculates average effort with confidence intervals
- Consolidates lessons learned from past features
- Provides code examples with file:line references

#### 2. Template Matcher (`src/templates/template-matcher.ts`)
Auto-matches features to 5 proven templates:
- **auth-system.yaml** - Authentication (OAuth2, JWT) - 28h
- **crud-endpoint.yaml** - REST API with CRUD - 8h
- **dashboard.yaml** - Analytics dashboard - 16h
- **api-integration.yaml** - Third-party API - 12h
- **file-upload.yaml** - Secure file upload - 10h

Scoring: Keyword overlap + Category boost (20%) + Name boost (30%)

#### 3. Todo File Generator (`src/planning/todo-file-generator.ts`)
Creates dual todo system automatically:
- **TodoWrite** items (in-session tracking)
- **todos/*.md** files (cross-session persistence)
- Auto-numbering, dependency graphs (Mermaid)
- Execution wave detection (parallel vs sequential)

### Enhanced /plan Command

```bash
/plan "Add user authentication"
```

**What Happens**:
1. **Pattern Search**: Finds 3 similar auth features → avg 27h ± 4h (88% confidence)
2. **Template Match**: Matches auth-system.yaml (88% score) → base 28h
3. **Combined Estimate**: 29h ± 3h (91% confidence - way better than ±50%)
4. **Dual Todos**: Creates 6 todo files + TodoWrite items
5. **Enhanced Output**: Confidence scores, risk assessment, execution waves

**Result**: Accurate estimates + historical learnings + proven patterns = **40% faster planning**

### Quick Start

```bash
# Plan with historical learning
/plan "Add user authentication"

# Work on generated todos
/work todos/008-pending-p1-auth-api.md

# After completion - store learnings for next time
/learn "Completed auth in 26h - Google OAuth needs CORS config"
```

### Documentation

- **Complete Guide**: [docs/guides/compounding-engineering.md](docs/guides/compounding-engineering.md)
- **Pattern Search API**: [src/rag/pattern-search.ts](src/rag/pattern-search.ts)
- **Template Matcher API**: [src/templates/template-matcher.ts](src/templates/template-matcher.ts)
- **Todo Generator API**: [src/planning/todo-file-generator.ts](src/planning/todo-file-generator.ts)

---

## 🧠 Three-Layer Context System (v6.6.0+)

VERSATIL now includes an intelligent **three-layer context system** that personalizes every aspect of development:

### Context Priority Hierarchy

```
User Preferences (HIGHEST)
    ↓
Team Conventions
    ↓
Project Vision
    ↓
Framework Defaults (LOWEST)
```

**User preferences always win** - ensuring your personal coding style is respected while maintaining team standards and project goals.

### Key Features

#### 1. **CAG (Context-Aware Generation)**
All 18 agents (8 core + 10 sub-agents) generate code matching YOUR style:
- **Your async style**: `async/await` or promises
- **Your naming**: camelCase, snake_case, PascalCase
- **Your preferences**: tabs/spaces, quotes, semicolons
- **Your test framework**: jest, vitest, playwright

#### 2. **CRG (Context Resolution Graph)**
Intelligent context resolution with <50ms latency:
- Priority-based merging (User > Team > Project > Framework)
- Conflict detection and logging
- Graceful fallback to team/project/framework defaults

#### 3. **Auto-Detection**
Zero manual configuration - preferences learned from your code:
- Analyzes git commit history (90%+ accuracy)
- Detects indentation, quotes, naming, async style
- Onboarding takes 15 seconds (vs 10 minutes)

#### 4. **Privacy-Isolated Learning**
Your patterns stay private, team patterns shared appropriately:
- **User patterns**: Private to you only
- **Team patterns**: Shared with team members only
- **Project patterns**: Shared with project contributors only
- **Framework patterns**: Public to all users

### Quick Start

**First-time setup** (automatic during installation):
```bash
npm install @versatil/sdlc-framework
# Auto-detection runs automatically
# Preferences saved to ~/.versatil/users/[your-id]/profile.json
```

**Migrate existing project**:
```bash
npm run context:migrate
# Analyzes git history
# Creates user profile, project vision, team conventions
# Backup created automatically
```

**Test context system**:
```bash
npm run context:test
# Runs E2E integration test
# Verifies priority resolution
# Validates privacy isolation
```

### Performance Impact

- **Development velocity**: 36% faster (net improvement)
- **Code accuracy**: 96% (vs 75% before)
- **Code rework**: -88% (5% vs 40%)
- **Context resolution**: <50ms
- **Privacy isolation**: 100%

### Compounding Engineering

The context system enables **Compounding Engineering** - each feature makes the next faster:
- **Feature 1**: Baseline
- **Feature 2**: 17% faster
- **Feature 3**: 26% faster
- **Feature 4**: 31% faster
- **Feature 5**: **40% faster** ← Target achieved!

### Documentation

- **Complete Guide**: [docs/THREE_LAYER_CONTEXT_SYSTEM.md](docs/THREE_LAYER_CONTEXT_SYSTEM.md)
- **Framework Impact**: [docs/THREE_LAYER_CONTEXT_FRAMEWORK_IMPACT.md](docs/THREE_LAYER_CONTEXT_FRAMEWORK_IMPACT.md)
- **Implementation Status**: [docs/THREE_LAYER_CONTEXT_COMPLETE.md](docs/THREE_LAYER_CONTEXT_COMPLETE.md)

---

## 🤖 Agent Auto-Activation System

VERSATIL agents automatically activate based on file patterns and context - **no manual slash commands needed** for routine tasks.

### How It Works

```
Edit File → Hook Fires → JSON Suggestion → Claude Invokes Agent via Task Tool
```

**Example**: Edit `LoginForm.test.tsx` → Maria-QA automatically activates for quality validation

### Agent Triggers Quick Reference

| Agent | Auto-Activates On | Priority |
|-------|------------------|----------|
| **Maria-QA** | `*.test.*`, `*.spec.*`, `__tests__/**` | ⚡ High |
| **James-Frontend** | `*.tsx`, `*.jsx`, `*.vue`, `*.css` | 🎨 Medium |
| **Marcus-Backend** | `api/**`, `routes/**`, `*.api.*` | ⚙️ High |
| **Dana-Database** | `*.sql`, `migrations/**`, `*.prisma` | 🗄️ High |
| **Dr.AI-ML** | `ml/**/*.py`, `*.ipynb`, `models/**` | 🤖 Medium |
| **Alex-BA** | `requirements/**`, `*.feature` | 📊 Medium |
| **Sarah-PM** | `*.md`, `docs/**` | 👔 Low |
| **Oliver-MCP** | `mcp/**`, `*.mcp.*` | 🔌 Medium |

### Sub-Agent Routing (Automatic)

When editing backend/frontend code, the framework automatically routes to specialized sub-agents:

**Frontend**: React, Vue, Next.js, Angular, Svelte
**Backend**: Node.js, Python, Rails, Go, Java

**Complete Reference**: [.claude/AGENT_TRIGGERS.md](.claude/AGENT_TRIGGERS.md)

---

## 📚 Library-Specific Context (v6.6.0+)

**Per-Library Rules & Patterns for Precision Development**

Beyond project-wide conventions, VERSATIL supports library-specific context files (`claude.md`) in each major module. These files provide targeted guidance when working with specific parts of the codebase.

### The Four-Layer Context System

```
User Preferences (HIGHEST - ~/.versatil/users/[id]/profile.json)
    ↓
Library Context (NEW - src/[library]/claude.md)
    ↓
Team Conventions (CLAUDE.md, project root)
    ↓
Framework Defaults (LOWEST)
```

**Priority**: When conventions conflict, higher layers always win.

### How It Works

When you edit a file like `src/rag/pattern-search.ts`, the `before-prompt` hook:
1. Detects library from path: `rag`
2. Loads `src/rag/claude.md` if it exists
3. Injects library-specific context into system message
4. Combines with RAG patterns and team conventions

### Library Context Files

Each `claude.md` provides:
- **Purpose**: What the library does (1-2 sentences)
- **Key Concepts**: Core abstractions and patterns
- **Conventions & Rules**: Library-specific coding standards
- **Usage Patterns**: Copy-paste code examples
- **Important Gotchas**: Common mistakes and footguns
- **Related Libraries**: Dependencies and interactions
- **Testing Requirements**: Coverage and test patterns

### Priority Libraries (15 with context files)

| Library | Purpose | Key Pattern |
|---------|---------|-------------|
| **agents/** | OPERA agent definitions | Handoff contracts, role specialization |
| **rag/** | Pattern search & RAG | GraphRAG first, Vector fallback |
| **orchestration/** | Workflow coordination | Phase detection, state persistence |
| **planning/** | Feature planning | CODIFY phase, effort estimation |
| **templates/** | Template matching | 70% threshold, keyword scoring |
| **hooks/** | Event system | Native SDK, hook lifecycle |
| **mcp/** | MCP integration | Server management, protocol |
| **context/** | Context management | Three-layer priority system |
| **intelligence/** | AI/ML features | Adaptive learning |
| **learning/** | Learning system | Codification, feedback loops |
| **memory/** | Memory management | State persistence, caching |
| **testing/** | Test infrastructure | 80%+ coverage, Maria-QA patterns |
| **validation/** | Quality gates | Contract validation, rules |
| **ui/** | UI components | React, accessibility (WCAG 2.1 AA) |
| **dashboard/** | Dashboard features | Charts, visualization |

### Benefits

- **Faster onboarding**: New contributors get library-specific guidance immediately
- **Fewer mistakes**: Common gotchas documented with solutions
- **Consistent patterns**: Everyone follows the same library conventions
- **Precision context**: Only inject rules relevant to current work

### Example: src/rag/claude.md

```markdown
# RAG (Retrieval-Augmented Generation)

## Purpose
Pattern search and historical context retrieval using GraphRAG + Vector stores.

## Key Rule
⚠️ **Always try GraphRAG first** - It's offline and has no API quota

## Common Pattern
\`\`\`typescript
import { patternSearchService } from './pattern-search.js';

const result = await patternSearchService.searchSimilarFeatures({
  description: 'Add user authentication',
  min_similarity: 0.75,
  limit: 5
});
\`\`\`

## Important Gotcha
GraphRAG initialization can fail silently - check `search_method` in result.
```

### Creating New Library Context

When creating a new library or major module:

1. Copy template: `templates/context/library-claude.md.template`
2. Fill in sections based on actual code
3. Include real examples with file:line references
4. Document gotchas from git history/issues
5. Keep under 200 lines (signal over noise)
6. Place in `src/[library]/claude.md`

**Template**: [templates/context/library-claude.md.template](templates/context/library-claude.md.template)
**Audit Report**: [docs/context/LIBRARY_AUDIT_REPORT.md](docs/context/LIBRARY_AUDIT_REPORT.md)

---
