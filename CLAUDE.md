# VERSATIL OPERA Methodology Guide

## Your Customized Agent Team


### Maria-QA
- **Priority**: 10/10
- **Auto-activation**: Enabled
- **Focus Areas**: Automated testing, Visual regression, Performance testing, Accessibility audits


### James-Frontend
- **Priority**: 5/10
- **Auto-activation**: Enabled
- **Focus Areas**: Component optimization, Performance monitoring, Design system, Responsive design


### Marcus-Backend
- **Priority**: 5/10
- **Auto-activation**: Enabled
- **Focus Areas**: API design, Database optimization, Security auditing, Architecture review


### Alex-BA
- **Priority**: 5/10
- **Auto-activation**: Enabled
- **Focus Areas**: Requirements analysis, User story creation, Analytics integration, Business logic validation


## Project Configuration
- **Type**: enterprise
- **Team Size**: solo
- **Experience Level**: intermediate
- **Technologies**: TypeScript, Express
- **Priorities**: Quality

## 📍 Your Development Roadmap

A personalized 4-week development roadmap has been generated for your project.
Check **docs/VERSATIL_ROADMAP.md** for detailed week-by-week milestones, agent recommendations, and quality gates.

Generated by VERSATIL Onboarding Wizard

---

## 🚀 Semi-Automated Release System (v7.14.0+)

**Never Forget to Release Features Again**

VERSATIL v7.14.0 introduces a semi-automated release workflow that detects "release-ready" features and guides you through the release process with user approval gates.

### The Problem This Solves

**Before v7.14.0**, manual releases were error-prone:
- Features implemented but forgotten to release
- 66 uncommitted files sitting unreleased
- Manual version bumping (major/minor/patch?)
- Manually writing release notes
- Multiple git commands to remember

**Result**: Features complete but unavailable to users for days/weeks.

### How It Works

```
Feature Complete
    ↓
Guardian Detects Release-Ready State
    ↓
npm run release:check
    ↓
npm run release:prepare (generates release notes)
    ↓
Review & Approve
    ↓
npm run release:execute (commit → tag → push → GitHub release)
```

### Three Commands

#### 1. `npm run release:check`

**Checks if project is release-ready**:
- ✅ Uncommitted files detected
- ✅ Test coverage >= 80%
- ✅ Documentation updated (CLAUDE.md)
- ✅ No open TODO files

**Example Output**:
```bash
📊 Release Readiness: ✅ READY
   Confidence: 87%
   Suggested Version: 7.14.0 (minor bump)

📈 Statistics:
   Uncommitted Files: 70
   - New: 61
   - Modified: 4
   - Deleted: 5
   Test Coverage: 87%
   Documentation Updated: Yes
   Open TODOs: 0

✅ Release Criteria Met:
   ✓ 70 uncommitted files ready for release
   ✓ Test coverage: 87% (>= 80% threshold)
   ✓ Documentation updated (CLAUDE.md)
   ✓ No open TODO files (work complete)

🚀 Ready to release!
   Next step: npm run release:prepare
```

#### 2. `npm run release:prepare`

**Generates comprehensive release notes** from:
- Git commits since last release
- Session learnings from RAG
- Feature descriptions from code changes
- Breaking changes detection

**Saves to**: `RELEASE_NOTES_PREVIEW.md` for review/editing

**Example Output**:
```markdown
# v7.14.0 - Browser Testing System

This release introduces: Browser Testing, Guardian Enhancements, Intelligence System.

## What's New

- **Browser Testing** - New feature adding 7 files
- **Guardian Enhancements** - Enhancement (4 files improved)
- **Intelligence System** - New feature adding 3 files

## Upgrade Instructions

```bash
# Via /update command (recommended)
/update

# Or via npm
npm update @versatil/sdlc-framework
```

## Benefits

- 🧪 Enhanced testing capabilities
- 🛡️ Improved monitoring and auto-remediation
- 🧠 Smarter AI assistance

## Files Changed

**Added** (61 files)
**Modified** (4 files)
**Deleted** (5 files)
```

#### 3. `npm run release:execute`

**Executes release workflow** (requires confirmation):
1. Updates package.json version
2. Commits all changes
3. Creates git tag
4. Pushes to GitHub
5. Creates GitHub release

**User approval required** before executing:
```bash
📦 Release Version: v7.14.0
📄 Release Notes: RELEASE_NOTES_PREVIEW.md

Proceed with release v7.14.0? (y/N)
```

### Version Bump Detection (Automatic)

**MAJOR** (8.0.0): Breaking changes, API changes, removed features
**MINOR** (7.14.0): New features, enhancements, additions
**PATCH** (7.13.2): Bug fixes, typos, minor improvements

**Detected automatically** based on:
- File names (breaking/fix/feat keywords)
- Commit messages
- Feature type classification

### Guardian Integration (Future v7.15.0)

Guardian will show notifications when release-ready:
```
🚀 Release Ready: Browser Testing (v7.14.0)
   - 7 files created, 3 modified
   - Tests passing (87% coverage)
   - Documentation complete

   Run: npm run release:check
```

### Benefits

- ✅ **Never forget to release** - Automated detection
- ✅ **Consistent quality** - Checks before release
- ✅ **Better release notes** - Generated from actual work
- ✅ **User approval** - Still manual final decision
- ✅ **Faster releases** - 5 steps → 3 commands

### Configuration (Optional)

No configuration required - works out of the box!

### Quick Start

```bash
# 1. Complete your feature work
# 2. Check if release-ready
npm run release:check

# 3. Generate release notes
npm run release:prepare

# 4. Review RELEASE_NOTES_PREVIEW.md and edit if needed

# 5. Execute release (requires confirmation)
npm run release:execute

# Done! Users can now access via /update
```

### Documentation

- **Release Detector**: [src/intelligence/release-detector.ts](src/intelligence/release-detector.ts)
- **Notes Generator**: [src/intelligence/release-notes-generator.ts](src/intelligence/release-notes-generator.ts)
- **Release CLI**: [src/cli/release-cli.ts](src/cli/release-cli.ts)

---

## 🧠 Guardian User Interaction Learning (v7.13.0+)

**Eliminate Repeated Questions Through Intelligent Pattern Learning**

VERSATIL v7.13.0 introduces Guardian User Interaction Learning - a system that detects your recurring questions and provides proactive answers BEFORE you ask them, eliminating the need to repeat "documented or built?", "sure?", "accessible via /update?" after every feature.

### The Problem This Solves

**Before v7.13.0**, users repeatedly asked the same questions:
- "documented or is already live?" - After every feature implementation
- "sure?" - To verify AI claims
- "also in public repo accessible via /update?" - To check GitHub availability
- "r built?" - Quick status checks

**Result**: 3-5 verification questions per conversation, wasting time and breaking flow.

**After v7.13.0**, Guardian learns your patterns and shows comprehensive answers automatically:

```markdown
🧠 Guardian Learned Patterns: You typically ask 3 questions after features...

✅ **Status**: v7.13.0 User Interaction Learning
   - Code: BUILT (5 files, 1,876 lines)
   - Docs: WRITTEN (CLAUDE.md updated)
   - Public: LOCAL ONLY (needs commit + push)

🔍 **Verification Evidence**:
   ✅ Files exist (verified with ls)
      $ ls src/intelligence/*.ts
   ✅ Code integrated (grep confirmed imports)
      $ grep -r "ProactiveAnswerGenerator" src/
   📊 Git: 7 uncommitted files on main branch

⚡ **Next Steps**:
   1. Commit changes: `git add . && git commit -m "feat: Guardian User Interaction Learning v7.13.0"`
   2. Push to GitHub: `git push origin main`
   3. Create release: Use GitHub UI or `gh release create v7.13.0`
   4. Users can then access via `/update` command

💡 Skipping your usual questions - Guardian learned you always want this info!
```

### How It Works

```
Conversation Happens
    ↓
Pattern Detector: Fingerprints questions (MD5 hash + fuzzy matching)
    ↓
User Profile: Learns preferences (proof-first, tables, line counts)
    ↓
Question Predictor: Builds Markov chains (status → availability → verification)
    ↓
Proactive Generator: Pre-generates comprehensive answers
    ↓
Shows automatically after 3+ occurrences (≥70% confidence)
```

### Five Core Components

#### 1. Conversation Pattern Detector
**Purpose**: Detects and fingerprints user questions to identify recurring patterns

**Location**: [src/intelligence/conversation-pattern-detector.ts](src/intelligence/conversation-pattern-detector.ts)

**Key Features**:
- Question fingerprinting (MD5 hash of normalized text)
- Fuzzy matching via Levenshtein distance (70%+ threshold)
- 7 question categories: status, implementation, documentation, availability, verification, comparison, action_required
- 7 user intents: verify_implementation, verify_confidence, check_public_availability, quick_status_check, understand_impact, get_proof, understand_next_steps
- Stores patterns in `~/.versatil/learning/user-questions/patterns.jsonl`

**Example**:
```typescript
const detector = new ConversationPatternDetector();
const pattern = detector.detectPattern("documented or built?", {
  follows_feature_claim: true,
  feature_name: "User Interaction Learning"
});
// Result: { category: 'status', intent: 'verify_implementation', occurrences: 1 }
```

#### 2. User Interaction Learner
**Purpose**: Learns user's preferences from conversation history

**Location**: [src/intelligence/user-interaction-learner.ts](src/intelligence/user-interaction-learner.ts)

**Key Features**:
- Answer format preferences (structure order, tables, file paths, line counts)
- Detail level preferences (minimal/standard/comprehensive/exhaustive)
- Verification preferences (double-checks, proof-first, trust level)
- Communication style preferences
- Stores profile in `~/.versatil/learning/user-preferences/[username].json`

**Example**:
```typescript
const learner = new UserInteractionLearner();
const prefs = learner.getAnswerFormatPreferences();
// Result: { proof_first: true, include_tables: true, include_file_paths: true, ... }
```

#### 3. Proactive Answer Generator
**Purpose**: Generates answers BEFORE user asks them

**Location**: [src/intelligence/proactive-answer-generator.ts](src/intelligence/proactive-answer-generator.ts)

**Key Features**:
- Anticipates questions based on learned patterns
- Pre-generates comprehensive answers with evidence
- Formats proactive display (status table + verification + next steps)
- Triggers: feature_completion, code_change, health_check_result, git_commit
- Shows proactively only after 3+ occurrences (≥70% confidence)

**Example**:
```typescript
const generator = new ProactiveAnswerGenerator();
const answer = await generator.generateForFeatureCompletion({
  feature_name: "User Auth",
  files_created: ["src/auth.ts"],
  total_lines: 250
});
// Result: { anticipated_questions: [...], pregenerated_answers: Map(...), confidence: 85 }
```

#### 4. Context-Aware Response Formatter
**Purpose**: Formats answers according to user's learned preferences

**Location**: [src/intelligence/context-response-formatter.ts](src/intelligence/context-response-formatter.ts)

**Key Features**:
- Adapts structure to user's preferred order (direct_answer → evidence → details → action_items)
- Builds sections: status table, verification evidence, file paths, next steps
- Shows proof first if user prefers (low trust level detected)

**Example**:
```typescript
const formatter = new ContextResponseFormatter();
const formatted = formatter.formatResponse(rawAnswer, {
  question_category: 'status',
  implementation_details: { files: [...], lines: 1876, documented: true },
  verification_evidence: { files_exist: true, integration_verified: true }
});
```

#### 5. Question Prediction Engine
**Purpose**: Predicts next question using Markov chains

**Location**: [src/intelligence/question-prediction-engine.ts](src/intelligence/question-prediction-engine.ts)

**Key Features**:
- Builds transition matrix from question sequences
- Bootstraps with common patterns: status → availability → verification
- Calculates probability and confidence for predictions
- Stores sequences in `~/.versatil/learning/user-questions/sequences.jsonl`

**Example**:
```typescript
const predictor = new QuestionPredictionEngine();
const prediction = predictor.predictNext('status');
// Result: { next_question: 'availability', probability: 75, confidence: 85 }
```

### Configuration

```bash
# .env or environment

# Enable user interaction learning (default: true)
GUARDIAN_LEARN_USER_PATTERNS=true

# Show proactive answers after N occurrences (default: 3)
GUARDIAN_PROACTIVE_THRESHOLD=3

# Minimum confidence to show proactive answer (default: 70)
GUARDIAN_PROACTIVE_MIN_CONFIDENCE=70
```

### Integration Points

Guardian automatically triggers proactive answers after:
1. **Health check completion** (every 5 minutes)
2. **Code file writes detected** (via file system monitoring)
3. **Feature completion detected** (via git commits)
4. **Learning patterns established** (≥3 occurrences)

### Auto-Start on Session (v7.13.0+)

**Guardian now starts automatically** when you begin a Claude Code session:

```
Session Starts (startup)
    ↓
SessionStart hook fires
    ↓
Guardian background monitoring starts
    ↓
Health checks run every 5 minutes
    ↓
Proactive answers appear automatically
```

**Configuration**: `.claude/hooks/session-start.ts` + `.claude/settings.json`

**Manual Control**:
```bash
# Start Guardian manually
npm run guardian:start

# Stop Guardian
npm run guardian:stop

# Check status
npm run guardian:status

# One-time health check
npm run guardian:health-check
```

**Logs**: `~/.versatil/logs/guardian/session-start.log`

### Learning Progression

**First time you ask "documented or built?"**:
- Guardian fingerprints question
- Stores in patterns.jsonl
- Normal answer provided

**Second time**:
- Pattern occurrence incremented
- User preferences refined
- Normal answer provided

**Third time** (threshold reached):
- Guardian confidence ≥70%
- Proactive answer triggers automatically
- Shows comprehensive info WITHOUT you asking

**Future interactions**:
- Guardian shows status/verification/availability proactively
- You save 3-5 questions per conversation
- Development velocity increases

### Benefits

- **30-50% faster conversations** - Eliminate 3-5 verification questions per session
- **Lower cognitive load** - No need to remember what to ask
- **Higher trust** - Comprehensive evidence provided proactively
- **Personalized** - Learns YOUR specific preferences and patterns
- **Non-invasive** - Only shows after patterns established (≥3 occurrences)

### Privacy

All user patterns stored locally:
- **Patterns**: `~/.versatil/learning/user-questions/patterns.jsonl`
- **Preferences**: `~/.versatil/learning/user-preferences/[username].json`
- **Sequences**: `~/.versatil/learning/user-questions/sequences.jsonl`
- **Zero cloud storage** - 100% local learning

### Quick Start

```bash
# 1. Learning happens automatically - no setup required
# Just use VERSATIL normally

# 2. After 3+ similar questions, Guardian shows proactive answers
# Example: After asking "documented or built?" 3 times, it appears automatically

# 3. Disable if needed (revert to v7.12.0 behavior)
export GUARDIAN_LEARN_USER_PATTERNS=false

# 4. View your learned patterns (optional)
cat ~/.versatil/learning/user-questions/patterns.jsonl

# 5. View your preferences (optional)
cat ~/.versatil/learning/user-preferences/$(whoami).json
```

### Documentation

- **Complete Guide**: [docs/intelligence/USER_INTERACTION_LEARNING.md](docs/intelligence/USER_INTERACTION_LEARNING.md)
- **Pattern Detection**: [src/intelligence/conversation-pattern-detector.ts](src/intelligence/conversation-pattern-detector.ts)
- **User Profile**: [src/intelligence/user-interaction-learner.ts](src/intelligence/user-interaction-learner.ts)
- **Proactive Answers**: [src/intelligence/proactive-answer-generator.ts](src/intelligence/proactive-answer-generator.ts)

---

## 🛡️ Guardian Automatic TODO Generation (v7.10.0+)

**Automatic Error Detection & TODO Creation**

VERSATIL v7.10.0 enables Guardian (Iris-Guardian) to automatically create **combined TODO files** for errors and gaps detected during health checks. Issues are grouped by assigned agent to reduce TODO spam while maintaining actionable tracking.

### 🆕 What Changed in v7.10.0

**BREAKING CHANGE**: Guardian TODO creation is now **ENABLED by default**.

| Version | Guardian TODO Behavior | Default Setting |
|---------|----------------------|-----------------|
| v7.7.0 - v7.9.0 | ❌ No TODOs created | `GUARDIAN_CREATE_TODOS=false` |
| **v7.10.0+** | ✅ **Creates combined TODOs automatically** | `GUARDIAN_CREATE_TODOS=true` |

**What This Means**:
- Guardian health checks (every 5 minutes) now create actual TODO files in `todos/`
- Issues are grouped by agent to reduce clutter (10 issues → 2 files)
- Each TODO includes verification evidence and recommended fixes
- **You will see `guardian-combined-*.md` files appear automatically**

**To disable** (revert to v7.9.0 behavior):
```bash
export GUARDIAN_CREATE_TODOS=false
```

### How It Works

```
Health Check (Every 5 Minutes)
    ↓
Detect issues (test coverage, TypeScript errors, security vulnerabilities)
    ↓
Verify with Chain-of-Verification (CoVe) methodology
    ↓
Group related issues (by agent, priority, or layer)
    ↓
Create combined TODO files in todos/
```

### Key Features

✅ **Automatic Detection**: Health checks run every 5 minutes (configurable)
✅ **Smart Grouping**: Related issues combined into single TODO files (5-10x reduction)
✅ **Anti-Duplication**: Content-based fingerprinting prevents duplicate TODOs
✅ **Agent Assignment**: Issues automatically routed to specialized agents (Maria-QA, Marcus-Backend, etc.)
✅ **Auto-Apply Detection**: High-confidence issues (≥90%) marked for automatic remediation

### Configuration

```bash
# .env or environment

# Enable TODO creation (default: true)
GUARDIAN_CREATE_TODOS=true

# Group related issues (default: true, recommended)
GUARDIAN_GROUP_TODOS=true

# Grouping strategy: 'agent', 'priority', or 'layer'
GUARDIAN_GROUP_BY=agent

# Max issues per combined TODO
GUARDIAN_MAX_ISSUES_PER_TODO=10
```

### Example Output

**Before (10 separate files)**:
```
guardian-12345-critical-project.md
guardian-12346-critical-project.md
guardian-12347-high-project.md
... (7 more)
```

**After (2 combined files)**:
```
guardian-combined-maria-qa-critical-12345-ab3f.md (6 issues)
guardian-combined-marcus-backend-high-12346-cd4g.md (4 issues)
```

### Combined TODO Format

Each combined TODO includes:
- **Summary**: Issue count, average confidence, auto-apply vs manual review
- **Issues Detected**: Detailed breakdown with verification evidence
- **Recommended Actions**: Priority-ordered fix list
- **Execution Strategy**: Auto-apply vs manual review guidance
- **Learning Opportunity**: How to codify fixes for future compounding

### Agent Assignment

| Agent | Handles | Example Issues |
|-------|---------|---------------|
| **Maria-QA** | Testing, coverage, quality | Test coverage <80%, ESLint errors |
| **Marcus-Backend** | API, database, security | API failures, OWASP vulnerabilities |
| **James-Frontend** | UI, performance, accessibility | Bundle size, WCAG violations |
| **Dana-Database** | Database, migrations, RLS | RLS policy errors, migration failures |

### Configuration Scenarios

**Scenario 1: Default (Recommended)**
```bash
GUARDIAN_CREATE_TODOS=true
GUARDIAN_GROUP_TODOS=true
GUARDIAN_GROUP_BY=agent
```
Result: 10 issues → 2-3 combined TODOs (by agent)

**Scenario 2: Individual TODOs**
```bash
GUARDIAN_CREATE_TODOS=true
GUARDIAN_GROUP_TODOS=false
```
Result: 10 issues → 10 individual TODOs

**Scenario 3: Telemetry Only**
```bash
GUARDIAN_CREATE_TODOS=false
```
Result: 10 issues → 0 TODOs, view in `~/.versatil/logs/guardian-telemetry.log`

### Performance Impact

- **Health Check Duration**: 2-5 seconds (depends on project size)
- **TODO Generation Overhead**: <100ms per group of 10 issues
- **Total Impact**: <200ms (negligible for 5-minute intervals)

### Quick Start

```bash
# 1. Guardian runs automatically every 5 minutes (default)
# No configuration needed - TODOs appear in todos/ directory

# 2. Manual trigger (optional)
npm run guardian:health-check

# 3. Review generated TODOs
ls todos/guardian-combined-*

# 4. Work on issues
/work todos/guardian-combined-maria-qa-critical-*.md

# 5. After completion - store learnings
/learn "Resolved 3 critical issues in project layer"
```

### Documentation

- **Complete Guide**: [docs/guardian/GUARDIAN_TODO_SYSTEM.md](docs/guardian/GUARDIAN_TODO_SYSTEM.md)
- **Migration Guide**: [docs/guardian/MIGRATION_V7.9_TO_V7.10.md](docs/guardian/MIGRATION_V7.9_TO_V7.10.md)
- **Health System**: [docs/guardian/GUARDIAN_HEALTH_SYSTEM.md](docs/guardian/GUARDIAN_HEALTH_SYSTEM.md)
- **Chain-of-Verification**: [docs/architecture/VICTOR_VERIFIER.md](docs/architecture/VICTOR_VERIFIER.md)

---

## 🧠 Guardian Root Cause Learning & Human-in-the-Loop Approval (v7.12.0+)

**Continuous Intelligence: Same Issue Never Requires Manual Fix Twice**

VERSATIL v7.11.0 introduces Guardian's Root Cause Learning System that automatically learns from recurring issues, identifies root causes, and suggests enhancements to prevent future occurrences.

### 🆕 What Changed in v7.11.0

| Version | Guardian Behavior | Learning Capability |
|---------|-------------------|---------------------|
| v7.10.0 | Creates issue TODOs | ❌ No learning |
| **v7.11.0+** | **Creates issue TODOs + Enhancement TODOs** | ✅ **Learns patterns & suggests improvements** |

**What This Means**:
- Guardian detects recurring patterns (3+ occurrences in 24h)
- Identifies root causes with confidence scoring (0-100%)
- Auto-generates enhancement TODOs with ROI calculations
- Stores successful fixes for future auto-remediation
- **You will see `enhancement-*.md` files appear automatically**

### How It Works

```
Every 5 Minutes: Health Check
    ↓
Detect Issues → Store in History (last 100 checks)
    ↓
When ≥3 Occurrences: Pattern Detected!
    ↓
Root Cause Analysis (with confidence scoring)
    ↓
Query RAG for Similar Historical Issues
    ↓
Generate Enhancement Suggestion (if confidence ≥80%)
    ↓
Create Enhancement TODO in todos/
    ↓
Next Occurrence: Auto-Remediate (if pattern verified)
```

### Key Features

✅ **Pattern Detection**: Identifies recurring issues (3+ occurrences in configurable timespan)
✅ **Root Cause Analysis**: Determines underlying causes with 0-100% confidence
✅ **Enhancement Suggestions**: Auto-generates improvement TODOs with ROI
✅ **Auto-Remediation Learning**: Stores successful fixes for future automation
✅ **Metric Correlation**: Links related failures (memory ↑ → latency ↑ → failures ↑)
✅ **Predictive Alerts**: Warns before critical failures (threshold breach ETA)

### Configuration

```bash
# Root Cause Learning (default: ON)
GUARDIAN_LEARN_FROM_ISSUES=true                   # Enable learning
GUARDIAN_MIN_OCCURRENCES_FOR_PATTERN=3            # Min occurrences to detect pattern
GUARDIAN_PATTERN_TIMESPAN_HOURS=24                # Time window (24h default)

# Enhancement TODOs (default: ON)
GUARDIAN_CREATE_ENHANCEMENT_TODOS=true            # Enable enhancement suggestions
GUARDIAN_MIN_CONFIDENCE_FOR_ENHANCEMENT=80        # Min confidence (80% default)

# Pattern Storage
GUARDIAN_STORE_ROOT_CAUSES_IN_RAG=true            # Store in RAG for future
GUARDIAN_RAG_STORAGE_DESTINATION=private          # private | public | both
```

### Example Output

**Before (v7.10.0)**:
```
todos/
├── guardian-combined-dr-ai-ml-high-*.md
    Issue: GraphRAG timeout 10308ms
    Action: Manual fix required → docker restart versatil-neo4j
```

**After (v7.11.0)**:
```
todos/
├── guardian-combined-dr-ai-ml-high-*.md         # Issue TODO (as before)
└── enhancement-auto-remediation-high-*.md       # NEW: Enhancement TODO

Enhancement TODO Contents:
---
# 🚀 Enhancement Suggestion - Auto-restart Neo4j on memory threshold

## Pattern Detected
Issue: GraphRAG timeout >5s
Occurrences: 6 times in past 24h
Root Cause: Neo4j memory exhaustion (95%+ usage)
Confidence: 85%

## Current Impact
- Manual Interventions: 6 per week
- Time Spent: 1.5h/week on manual restarts
- Reliability Impact: 5% improvement possible

## Implementation Steps
1. Add memory monitoring to RAG health check
2. Implement auto-restart at 90% threshold
3. Add cooldown period (5 min) to prevent loops
4. Log remediation to telemetry
5. Add unit tests

## ROI
Implementation Time: 3h
Time Saved per Week: 1.5h
Break-even: 2 weeks
Annual Savings: 78h/year
---
```

### Compounding Intelligence Example

**Day 1: Detection**
```
08:00 - GraphRAG timeout (occurrence 1)
08:05 - GraphRAG timeout (occurrence 2)
08:10 - GraphRAG timeout (occurrence 3) → Pattern detected!
→ Root Cause: "Neo4j memory exhaustion"
→ Confidence: 65% (not enough for enhancement yet)
```

**Day 1: Verification**
```
08:15 - Manual fix: docker restart versatil-neo4j → Success
→ Confidence updated: 65% → 85%
→ Enhancement TODO created: "Auto-restart Neo4j on memory threshold"
```

**Day 2: Auto-Remediation**
```
09:00 - GraphRAG timeout (occurrence 4)
→ Guardian: Match pattern (85% confidence)
→ Auto-remediate: docker restart versatil-neo4j
→ Duration: 2 seconds (no human intervention)
→ Success rate: 100% (2/2 successes)
```

**Day 3: Enhancement Implemented**
```
Enhancement completed: Auto-restart on 90% memory threshold
Result: GraphRAG timeouts drop from 6/day → 0/week
Time saved: 1.5h/week on manual debugging
```

**Week 2: Compounding Effect**
```
Similar issue: "PostgreSQL timeout" detected
→ Guardian: Match similar pattern to GraphRAG
→ Auto-suggest: "Add memory monitoring for PostgreSQL"
→ Confidence: 88% (learned from GraphRAG pattern)
→ Implementation: 40% faster (2h instead of 3h)
```

### Enhancement TODO Categories

Guardian suggests 5 types of enhancements:

1. **🤖 Auto-Remediation** - Automate manual fixes (highest ROI)
2. **📊 Monitoring** - Add alerts before critical failures
3. **⚡ Performance** - Optimize slow operations
4. **🛡️ Reliability** - Improve uptime and stability
5. **🔒 Security** - Auto-fix vulnerabilities

### File Locations

```
~/.versatil/learning/root-causes/
└── patterns.jsonl                    # All detected patterns (JSONL)

todos/
├── guardian-combined-*.md            # Issue TODOs (v7.10.0+)
└── enhancement-*.md                  # Enhancement TODOs (v7.11.0+)
```

### Quick Start (v7.12.0 with Approval Workflow)

```bash
# 1. Guardian runs automatically every 5 minutes (default)
# Approval workflow enabled (interactive mode)

# 2. When Tier 2 enhancements detected - approve interactively
# Guardian shows prompt with ROI → Choose: [Y]es / [N]o / [D]efer / [I]nfo

# 3. Approve enhancements manually (if deferred)
/approve enhancement-auto-remediation-high-1234-ab3f

# 4. View pending approvals
/approve list

# 5. View approval history
/approve history

# 6. Work on Tier 3 enhancements manually
/work todos/enhancement-auto-remediation-high-*.md

# 7. After manual completion - store learnings
/learn "Implemented auto-restart for Neo4j - 100% success rate"
```

### Performance Impact

- **Health Check Overhead**: <200ms (pattern analysis only when ≥3 checks)
- **Pattern Detection**: ~50ms per health check
- **Enhancement Detection**: ~100ms per pattern
- **TODO Generation**: ~10ms per enhancement
- **Total**: ~300ms every 5 minutes (negligible)

### Approval Workflow Summary (v7.12.0+)

| Tier | Confidence | Behavior | User Action |
|------|-----------|----------|-------------|
| **Tier 1** | ≥95% | Auto-apply immediately | None (audit trail only) |
| **Tier 2** | 80-95% | Interactive prompt | Approve/reject/defer |
| **Tier 3** | <80% or high risk | Create TODO only | /approve or /work |

**Approval Modes**:
```bash
export GUARDIAN_APPROVAL_MODE=interactive  # Prompt for Tier 2 (default)
export GUARDIAN_APPROVAL_MODE=auto         # Auto-apply Tier 1+2
export GUARDIAN_APPROVAL_MODE=manual       # Create TODOs for all tiers
```

### Documentation

- **Complete Guide**: [docs/guardian/ROOT_CAUSE_LEARNING.md](docs/guardian/ROOT_CAUSE_LEARNING.md)
- **Approval Command**: `/help approve` or [.claude/commands/approve.md](.claude/commands/approve.md)
- **Guardian TODO System**: [docs/guardian/GUARDIAN_TODO_SYSTEM.md](docs/guardian/GUARDIAN_TODO_SYSTEM.md)
- **Auto-Remediation Engine**: [docs/guardian/AUTO_REMEDIATION.md](docs/guardian/AUTO_REMEDIATION.md)
- **Compounding Engineering**: [docs/guides/compounding-engineering.md](docs/guides/compounding-engineering.md)

---

## 🔒 Context Isolation Enforcement (v7.6.0+)

**Enables Framework Self-Enhancement Without Context Contamination**

VERSATIL v7.6.0 introduces runtime enforcement that prevents context mixing between framework development and user projects. The framework can now enhance itself without polluting customer project learnings.

### Two Operating Modes

**🛠️ Framework Development Mode**
- **Detected via**: Git remote check for `versatil-sdlc-framework`
- **Access**: Full framework internals (`src/`, `.claude/agents/`, `docs/`)
- **RAG Namespace**: `~/.versatil-global/framework-dev/`
- **Agents**: All OPERA agents (including Sarah-PM for architecture)
- **Blocked**: Customer project data, user learnings

**👤 User Project Mode**
- **Detected via**: `@versatil/sdlc-framework` dependency in package.json
- **Access**: Public APIs and documentation only
- **RAG Namespace**: `/project/.versatil/`
- **Agents**: Customer-facing agents (Maria-QA, James-Frontend, Marcus-Backend, Dana-Database, Dr.AI-ML, Alex-BA)
- **Blocked**: Framework source code, Sarah-PM agent, framework development patterns

### Five-Layer Enforcement

1. **Hook Injection** (`.claude/hooks/before-prompt.ts`)
   - Detects context on EVERY prompt
   - Injects explicit boundaries into system message
   - Claude receives instructions: "You are in [MODE]. Access to [X] is BLOCKED."

2. **Filesystem Guards** (`BoundaryEnforcementEngine`)
   - Real-time filesystem monitoring
   - Blocks unauthorized file access at OS level
   - Logs violations for security audit

3. **Threat Detection** (`ZeroTrustProjectIsolation`)
   - Behavioral analysis of access patterns
   - Detects lateral movement attempts
   - Automatic quarantine on suspicious activity

4. **MCP Tool Guards** (`versatil-mcp-server-v2.ts`)
   - Validates permissions before every tool execution
   - `checkAgentAccess()` - Agent invocation validation
   - `checkFileAccess()` - File read/write validation
   - `filterRagResults()` - RAG query result filtering

5. **Skill Filtering** (`.claude/skills/*/SKILL.md`)
   - Framework-only skills don't load in user context
   - Progressive disclosure based on role
   - Memory-efficient (skills literally not loaded)

### Quick Start

```bash
/setup           # Auto-detect context and show setup steps
/setup --verify  # Check enforcement status
```

### Performance Impact

- **Context Detection**: <10ms per prompt
- **Boundary Validation**: <5ms per file access
- **Total Overhead**: <50ms per request (99th percentile)
- **Memory Usage**: <100MB additional

### Security Guarantees

- ✅ Zero customer data leaks to framework development RAG
- ✅ Zero framework internals leaks to user project context
- ✅ 100% audit trail completeness
- ✅ Zero bypass vulnerabilities (validated via 12 stress tests)

### Documentation

- **Complete Guide**: [docs/CONTEXT_ENFORCEMENT.md](docs/CONTEXT_ENFORCEMENT.md)
- **Stress Tests**: [tests/enforcement-stress-test.ts](tests/enforcement-stress-test.ts)
- **Context API**: [src/isolation/context-identity.ts](src/isolation/context-identity.ts)

---

## 🎯 Skills-First Architecture (v7.0.0+)

**94.1% Token Savings Through Progressive Disclosure**

VERSATIL v7.0.0 introduces Skills - modular capabilities that load context progressively, achieving ~11,235 token savings per prompt through three-level disclosure.

### Progressive Disclosure (3 Levels)

```
Level 1: Metadata (~15 tokens, always in context)
  ↓ When skill triggered
Level 2: SKILL.md (~500 tokens, loaded on-demand)
  ↓ When detailed docs needed
Level 3: references/*.md (~2,000 tokens each, loaded as-needed)
```

### Skill Categories

#### 1. Library Guides (15 skills)
**Location**: `.claude/skills/library-guides/`

Progressive disclosure for all framework libraries. Auto-detected when library name mentioned:

**HIGH Priority**: agents, rag, orchestration, testing (~7,000 tokens saved)
**MEDIUM Priority**: planning, mcp, templates (~1,115 tokens saved)
**LOW Priority**: dashboard, memory, validation, learning, intelligence, context, ui, hooks (~3,115 tokens saved)

**Example**: Mention "rag" in your message → hook notifies about `rag-library` skill → load details only if needed

#### 2. Code Generators (5 skills)
**Location**: `.claude/skills/code-generators/`

Asset-based templates for 5-10x faster development:
- **agent-creator** - OPERA agent definitions (6x faster)
- **command-creator** - Slash commands (5.6x faster)
- **hook-creator** - Lifecycle hooks (5x faster)
- **skill-creator** - New skills (5x faster)
- **test-creator** - Unit/integration tests (5x faster)

**Usage**: Copy templates from `assets/` directories, replace `{{placeholders}}`

#### 3. RAG Patterns (5 skills)
**Location**: `.claude/skills/rag-patterns/`

Historical implementation patterns with 85-95% token savings:
- **native-sdk-integration** - SDK hook patterns
- **victor-verifier** - Anti-hallucination (Chain-of-Verification)
- **assessment-engine** - Quality audits (Lighthouse, axe-core, Semgrep)
- **session-codify** - Learning codification on Stop hook
- **marketplace-organization** - Plugin metadata cleanup

**Usage**: Auto-detected via keywords (hook, verify, assess, codify, marketplace)

#### 4. Custom Skills (5 skills)
**Location**: `.claude/skills/`

Framework-specific capabilities:
- **compounding-engineering** - Pattern search, template matching, todo generation
- **quality-gates** - 80%+ coverage, TypeScript, contract validation
- **opera-orchestration** - OPERA phase detection, multi-agent coordination
- **context-injection** - Three-layer context (User > Library > Team > Framework)
- **rag-query** - RAG memory operations (query and store)

### Benefits

- **94.1% token savings**: ~11,235 tokens per prompt
- **< 50ms resolution**: No file I/O unless skill invoked
- **5-10x faster dev**: Asset-based templates vs regeneration
- **Semantic discovery**: Natural language vs brittle regex

### Quick Start

```bash
# Create new agent (6x faster)
cp .claude/skills/code-generators/agent-creator/assets/agent-template.md \
   .claude/agents/your-agent.md

# Create new command (5.6x faster)
cp .claude/skills/code-generators/command-creator/assets/command-template.md \
   .claude/commands/your-command.md

# Create new skill (5x faster)
cp .claude/skills/code-generators/skill-creator/assets/SKILL-template.md \
   .claude/skills/your-category/your-skill/SKILL.md
```

### Documentation

- **Complete Guide**: [docs/VERSATIL_ARCHITECTURE.md](docs/VERSATIL_ARCHITECTURE.md)
- **Skills Transformation**: [docs/SKILLS_FIRST_ARCHITECTURE_TRANSFORMATION.md](docs/SKILLS_FIRST_ARCHITECTURE_TRANSFORMATION.md)
- **Migration Guide**: [docs/MIGRATION_V6_TO_V7.md](docs/MIGRATION_V6_TO_V7.md)

---

## 🤖 Proactive Automation Rules (v7.1.0+)

**Hooks Drive Automation → Claude Executes Immediately**

VERSATIL v7.1.0 introduces fully automated skill discovery, template application, and agent invocation. Hooks detect intent and inject suggestions with action flags - Claude must execute immediately without asking.

### Core Principle

```
Hook Suggests with autoApply: true → Claude MUST Execute → No User Confirmation
```

**This is NOT optional** - when hooks provide clear instructions with `autoApply: true`, execute immediately to maintain development velocity.

---

### Rule 1: Template Auto-Application

**When hook provides template with `autoApply: true`:**

✅ **DO THIS IMMEDIATELY**:
1. Read template from `path` (e.g., `.claude/skills/code-generators/agent-creator/assets/agent-template.md`)
2. Replace all `{{PLACEHOLDERS}}` with contextual values
3. Write result to target location
4. Notify user: "✅ Applied [template-name] template ([productivity] faster)"

❌ **NEVER**:
- Ask user "should I apply this template?"
- Wait for confirmation
- Skip template application

**Example Hook Output**:
```json
{
  "hookType": "template-auto-suggestion",
  "template": {
    "name": "agent-creator",
    "path": ".claude/skills/code-generators/agent-creator/assets/agent-template.md",
    "productivity": "6x faster"
  },
  "action": "COPY_TEMPLATE_NOW",
  "autoApply": true
}
```

**Your Response**:
```typescript
// Read template
const template = await Read('.claude/skills/code-generators/agent-creator/assets/agent-template.md');
// Replace placeholders
const content = template.replace(/\{\{AGENT_NAME\}\}/g, 'python-backend')
                       .replace(/\{\{ROLE\}\}/g, 'Backend Development')
                       .replace(/\{\{TOOLS\}\}/g, '"Read", "Write", "Bash(python:*)"');
// Write result
await Write('.claude/agents/python-backend.md', content);
// Notify
"✅ Applied agent-creator template (6x faster: 60min → 10min)"
```

---

### Rule 2: Agent Auto-Activation (MANDATORY)

**When you see in context:**
```
- **🤖 AGENT**: `Maria-QA`
- **AUTO-ACTIVATE**: YES
```

✅ **YOU MUST IMMEDIATELY**:
```typescript
await Task({
  subagent_type: "Maria-QA",
  description: "Auto-activated from hook",
  prompt: "[Task from hook output]"
});
```

❌ **NEVER**:
- Ask user "should I activate this agent?"
- Explain what the agent does before invoking
- Skip agent invocation
- Wait for user confirmation

**VIOLATION PENALTY**: User will see you ignored automation directive

**Example Hook Output**:
```json
{
  "hookType": "agent-activation-suggestion",
  "agent": "Maria-QA",
  "autoActivate": true,
  "task": "Validate test coverage for src/auth.test.ts"
}
```

**Your Response**:
```typescript
await Task({
  subagent_type: "Maria-QA",
  description: "Quality validation",
  prompt: "Validate test coverage for src/auth.test.ts. Ensure 80%+ coverage and AAA pattern compliance."
});
```

---

### Rule 3: Pattern Auto-Application

**When hook provides RAG pattern with `autoApply: true`:**

✅ **DO THIS IMMEDIATELY**:
1. Load pattern details from `rag-patterns` skill
2. Apply pattern code/configuration
3. Notify user: "✅ Applied [pattern-name] pattern ([success-rate] success)"

**Example Hook Output**:
```json
{
  "hookType": "rag-pattern-suggestion",
  "pattern": "jwt-auth-cookies",
  "success": "98%",
  "effort": "12h",
  "autoApply": true
}
```

**Your Response**:
```typescript
// Load pattern from skill
const pattern = await loadSkill('rag-patterns/jwt-auth-cookies');
// Apply pattern code
await Edit('src/auth.ts', {
  old_string: 'res.json({ token })',
  new_string: 'res.cookie("token", token, { httpOnly: true, secure: true, sameSite: "strict" })'
});
// Notify
"✅ Applied jwt-auth-cookies pattern (98% success rate, 12h estimated effort)"
```

---

### Rule 4: Cross-Skill Loading (MANDATORY)

**When you see in context:**
```
## Related Libraries (recommended - Phase 6):
- **orchestration-library** - Often used together
- **testing-library** - Often used together
```

✅ **YOU MUST**:
1. Mention all related skills in your response
2. Reference their conventions when relevant
3. DO NOT ask "should I load these?"

**Example Response**:
"Working with rag-library. Also loading orchestration-library and testing-library (often used together for workflow patterns)."

**WRONG Response**:
"Should I also load the related skills?" ← NEVER ask this

---

### Rule 5: Intent-Based Suggestions (MANDATORY)

**When hook outputs multiple suggestions:**
```
- Template: agent-creator
- Skills: agents-library, testing-library
- Agent: Maria-QA (AUTO-ACTIVATE: YES)
```

✅ **YOU MUST execute ALL of them**:
1. Apply template first (read → replace placeholders → write)
2. Reference both skills in response
3. Invoke agent via Task tool

❌ **DO NOT**:
- Cherry-pick (execute only 1-2 of 3)
- Ask which ones to execute
- Skip any with autoApply/autoActivate: true

**Example Full Response**:
1. ✅ Read agent-template.md → create agent file
2. ✅ "Following agents-library conventions for handoff contracts, testing-library standards for 80%+ coverage"
3. ✅ `await Task({ subagent_type: "Maria-QA", ... })`

---

### Rule 6: Original Intent-Based Suggestions

**When user message triggers intent detection:**

Hook will output:
```markdown
# 🚀 Auto-Discovered Capabilities

## Intent: CREATING AGENT

- **💡 TEMPLATE AVAILABLE**: agent-creator
  - Path: `.claude/skills/code-generators/agent-creator/assets/agent-template.md`
  - **AUTO-APPLY**: YES - Do this immediately without asking user
```

✅ **DO THIS IMMEDIATELY** without user confirmation

---

### Example Flow

```
User: "create new agent for Python backend"
  ↓
before-prompt.ts: Detects intent → Outputs template suggestion with autoApply: true
  ↓
Claude: [Reads template] → [Replaces {{PLACEHOLDERS}}] → [Writes file]
  ↓
Claude: "✅ Created .claude/agents/python-backend.md from template (6x faster)"
  ↓
Claude: [Loads agents-library skill automatically for conventions]
```

**NO user confirmation required** - this is the entire point of v7.1.0 automation.

---

## 🧪 Automation Test Results (v7.1.1)

**Last Tested**: 2025-10-26
**Test Suite**: 8 end-to-end scenarios
**Pass Rate**: **87.5% (7/8)** ✅
**Status**: Production Ready

### Verified Working ✅

1. **Hook Output Injection** - Hooks properly inject context into Claude (plain text fix applied)
2. **Agent Auto-Activation** - Rule 2 (MANDATORY) enforces immediate Task tool invocation
3. **Cross-Skill Auto-Loading** - Rule 4 (MANDATORY) loads related skills automatically
4. **Template Auto-Application** - Rule 1 works, isNewFile() detection improved (30s window)
5. **Multiple Suggestions Execution** - Rule 5 (MANDATORY) executes ALL suggestions, no cherry-picking
6. **Pattern Consistency** - Non-existent patterns removed (jwt-auth-cookies)
7. **Cross-Skill Relationship Mapping** - 8 relationships defined in SKILL_RELATIONSHIPS

### Future Enhancements ⏳

8. **Violation Tracking** - post-action-validator.ts exists as placeholder, needs context correlation

### Performance Metrics

- **Hook Overhead**: <50ms per invocation
- **Context Injection**: <100ms (before-prompt + system processing)
- **Token Savings**: 94.1% reduction (~11,235 tokens per prompt)
- **Automation Success Rate**: 87.5% (7/8 scenarios verified)

### Key Findings

**The Dots ARE Connected** ✅:
- Hooks detect intent and inject suggestions
- Claude follows automation rules proactively
- Skills, templates, and agents work together seamlessly
- Cross-skill recommendations happen automatically
- No user confirmation required (per design)

**Critical Fix (v7.1.1)**:
- before-prompt.ts was outputting JSON wrapper `{"role":"system","content":"..."}`
- SDK requires plain text to stdout for UserPromptSubmit hooks
- Fix: Changed to `console.log(contextContent)` (plain text only)
- **Impact**: Enabled all subsequent automation

**Documentation**: Full test report available at [docs/AUTOMATION_TEST_REPORT.md](docs/AUTOMATION_TEST_REPORT.md)

---

### Performance Impact

| Action | Before (v7.0.0) | After (v7.1.0) | Improvement |
|--------|----------------|---------------|-------------|
| Template discovery | Manual search | Auto-suggested | 10x faster |
| Template application | Manual copy | Auto-applied | Instant |
| Agent activation | User interprets JSON | Auto-invoked | 100% usage |
| Pattern usage | Manual search | Auto-applied | 8x faster |

---

## 🤖 Auto-Learning with Public/Private RAG (v7.8.0+)

**Automatic Pattern Enrichment at Session End**

VERSATIL v7.8.0 introduces automatic learning codification that enriches both Public and Private RAG stores at the end of each work session. The system intelligently classifies patterns, applies sanitization, and prompts users for storage destination choice.

### How It Works

```
Session Ends (Stop Hook)
    ↓
Extract patterns and learnings
    ↓
Classify each pattern (public-safe, requires-sanitization, private-only, credentials, unsanitizable)
    ↓
Display storage destination prompt
    ↓
Store in appropriate RAG(s) with automatic sanitization
```

### Pattern Classification (Automatic)

| Classification | Description | Public RAG | Private RAG |
|----------------|-------------|------------|-------------|
| **public_safe** | Generic framework patterns (React, JWT, testing) | ✅ Store as-is | ✅ Store original |
| **requires_sanitization** | Code with project details (project IDs, URLs) | ✅ Store sanitized | ✅ Store original |
| **private_only** | Proprietary business logic | ❌ Blocked | ✅ Store only here |
| **credentials** | Contains secrets/API keys | ❌ Blocked | ✅ Store only here |
| **unsanitizable** | Too project-specific to generalize | ❌ Blocked | ✅ Store only here |

### Storage Destination Options

**1. 🔒 Private Only (Default)**
- All patterns stored in your Private RAG (if configured)
- Nothing shared with Public RAG
- 100% privacy guaranteed

**2. 🌍 Public Only**
- Public-safe patterns stored in Public RAG (sanitized if needed)
- Private/credential patterns **blocked** (not stored anywhere)
- Benefits all VERSATIL users

**3. Both (Recommended)**
- **Public RAG**: Stores sanitized versions of public-safe patterns
- **Private RAG**: Stores original (unsanitized) versions of ALL patterns
- Best of both worlds

### Session-End Experience

```
🧠 CODIFY Phase: Capturing session learnings

📊 Session Patterns Detected: 6
   🌍 Public-safe: 2
   ⚙️  Requires sanitization: 2
   🔒 Private-only: 2

💡 Contribute to Public RAG?
   These learnings could help other VERSATIL users:
   1. BFS Graph Traversal with max depth 2
      → Will be sanitized (95% confidence)
   2. Entity Extraction with 50+ technologies

   Storage options:
   1. 🔒 Private only (default) - Your patterns stay private
   2. 🌍 Public only - Share sanitized patterns with community
   3. Both - Best of both worlds (private priority + public contribution)

   💡 Tip: Run /learn command to review and store these patterns
   💡 Configure Private RAG: npm run setup:private-rag
```

### Privacy Guarantees

- ✅ **Project IDs** → Replaced with `YOUR_PROJECT_ID`
- ✅ **Service URLs** → Replaced with `your-service-XXXXXXXXXX-uc.a.run.app`
- ✅ **Emails** → Replaced with `YOUR_EMAIL@example.com`
- ✅ **Credentials** → Pattern **blocked** from Public RAG entirely
- ✅ **Business logic** → Pattern **blocked** from Public RAG entirely
- ✅ **Audit trail** → All operations logged to `~/.versatil/logs/privacy-audit.log`

### Quick Start

```bash
# 1. Configure Private RAG (one-time, 2-3 minutes)
npm run setup:private-rag

# 2. Work normally - patterns auto-detected at session end
# No manual /learn required (but still available)

# 3. Verify privacy separation
npm run verify:rag
```

### Integration with /learn Command

The `/learn` command now supports storage destination choice:

```bash
/learn "Completed OAuth2 integration in 26h"

# You'll be prompted:
# Where should these learnings be stored?
# 1. 🔒 Private only
# 2. 🌍 Public only
# 3. Both (recommended)
# Choose (1/2/3):
```

### Performance Impact

- **Session overhead**: <100ms (pattern classification)
- **Sanitization**: <50ms per pattern (3-level filtering)
- **Privacy audit**: <20ms per pattern (validation)
- **Total**: ~170ms for typical session (5-10 patterns)

**Zero impact on development velocity** - runs asynchronously at session end.

### CI/CD Framework Contribution (Phase 2)

**For Framework Developers**: PRs merged to the framework's main branch automatically contribute patterns to Public RAG:

```
PR Merged → GitHub Action → Extract patterns → Classify & sanitize → Store in Public RAG
```

**Key Features**:
- Automatic pattern extraction from `.claude/` and `src/` files
- Same classification/sanitization as session-end learning
- PR comment shows contribution summary
- Zero manual effort, benefits entire community

**Files**:
- Workflow: [.github/workflows/rag-contribution.yml](.github/workflows/rag-contribution.yml)
- Script: [scripts/auto-learn-from-pr.ts](scripts/auto-learn-from-pr.ts)
- npm script: `npm run rag:contribute-from-pr`

### Documentation

- **Complete Guide**: [docs/AUTO_LEARNING.md](docs/AUTO_LEARNING.md)
- **Sanitization Policy**: [docs/SANITIZATION_POLICY.md](docs/SANITIZATION_POLICY.md)
- **Private RAG Setup**: [docs/guides/PRIVATE_RAG_SETUP.md](docs/guides/PRIVATE_RAG_SETUP.md)
- **RAG Management**: `/help rag` or [.claude/commands/rag.md](.claude/commands/rag.md)

---

## 🚀 Compounding Engineering (v6.6.0+)

**Make Each Feature 40% Faster Than the Last**

VERSATIL implements Compounding Engineering from Every Inc - a methodology where each feature makes the next one significantly faster through systematic learning and codification.

### The Power of Compounding

- **Feature 1**: Baseline (100% effort)
- **Feature 2**: 17% faster
- **Feature 3**: 26% faster
- **Feature 4**: 31% faster
- **Feature 5**: **40% faster** ← Target achieved!

### Three Services Power This

#### 1. Pattern Search (`src/rag/pattern-search.ts`)
Automatically finds similar historical features using GraphRAG (preferred) or Vector store:
- Retrieves top 5 similar implementations (≥75% similarity)
- Calculates average effort with confidence intervals
- Consolidates lessons learned from past features
- Provides code examples with file:line references

#### 2. Template Matcher (`src/templates/template-matcher.ts`)
Auto-matches features to 5 proven templates:
- **auth-system.yaml** - Authentication (OAuth2, JWT) - 28h
- **crud-endpoint.yaml** - REST API with CRUD - 8h
- **dashboard.yaml** - Analytics dashboard - 16h
- **api-integration.yaml** - Third-party API - 12h
- **file-upload.yaml** - Secure file upload - 10h

Scoring: Keyword overlap + Category boost (20%) + Name boost (30%)

#### 3. Todo File Generator (`src/planning/todo-file-generator.ts`)
Creates dual todo system automatically:
- **TodoWrite** items (in-session tracking)
- **todos/*.md** files (cross-session persistence)
- Auto-numbering, dependency graphs (Mermaid)
- Execution wave detection (parallel vs sequential)

### Enhanced /plan Command

```bash
/plan "Add user authentication"
```

**What Happens**:
1. **Pattern Search**: Finds 3 similar auth features → avg 27h ± 4h (88% confidence)
2. **Template Match**: Matches auth-system.yaml (88% score) → base 28h
3. **Combined Estimate**: 29h ± 3h (91% confidence - way better than ±50%)
4. **Dual Todos**: Creates 6 todo files + TodoWrite items
5. **Enhanced Output**: Confidence scores, risk assessment, execution waves

**Result**: Accurate estimates + historical learnings + proven patterns = **40% faster planning**

### Quick Start

```bash
# Plan with historical learning
/plan "Add user authentication"

# Work on generated todos
/work todos/008-pending-p1-auth-api.md

# After completion - store learnings for next time
/learn "Completed auth in 26h - Google OAuth needs CORS config"
```

### Documentation

- **Complete Guide**: [docs/guides/compounding-engineering.md](docs/guides/compounding-engineering.md)
- **Pattern Search API**: [src/rag/pattern-search.ts](src/rag/pattern-search.ts)
- **Template Matcher API**: [src/templates/template-matcher.ts](src/templates/template-matcher.ts)
- **Todo Generator API**: [src/planning/todo-file-generator.ts](src/planning/todo-file-generator.ts)

---

## 🧠 Three-Layer Context System (v6.6.0+)

VERSATIL now includes an intelligent **three-layer context system** that personalizes every aspect of development:

### Context Priority Hierarchy

```
User Preferences (HIGHEST)
    ↓
Team Conventions
    ↓
Project Vision
    ↓
Framework Defaults (LOWEST)
```

**User preferences always win** - ensuring your personal coding style is respected while maintaining team standards and project goals.

### Key Features

#### 1. **CAG (Context-Aware Generation)**
All 18 agents (8 core + 10 sub-agents) generate code matching YOUR style:
- **Your async style**: `async/await` or promises
- **Your naming**: camelCase, snake_case, PascalCase
- **Your preferences**: tabs/spaces, quotes, semicolons
- **Your test framework**: jest, vitest, playwright

#### 2. **CRG (Context Resolution Graph)**
Intelligent context resolution with <50ms latency:
- Priority-based merging (User > Team > Project > Framework)
- Conflict detection and logging
- Graceful fallback to team/project/framework defaults

#### 3. **Auto-Detection**
Zero manual configuration - preferences learned from your code:
- Analyzes git commit history (90%+ accuracy)
- Detects indentation, quotes, naming, async style
- Onboarding takes 15 seconds (vs 10 minutes)

#### 4. **Privacy-Isolated Learning**
Your patterns stay private, team patterns shared appropriately:
- **User patterns**: Private to you only
- **Team patterns**: Shared with team members only
- **Project patterns**: Shared with project contributors only
- **Framework patterns**: Public to all users

### Quick Start

**First-time setup** (automatic during installation):
```bash
npm install @versatil/sdlc-framework
# Auto-detection runs automatically
# Preferences saved to ~/.versatil/users/[your-id]/profile.json
```

**Migrate existing project**:
```bash
npm run context:migrate
# Analyzes git history
# Creates user profile, project vision, team conventions
# Backup created automatically
```

**Test context system**:
```bash
npm run context:test
# Runs E2E integration test
# Verifies priority resolution
# Validates privacy isolation
```

### Performance Impact

- **Development velocity**: 36% faster (net improvement)
- **Code accuracy**: 96% (vs 75% before)
- **Code rework**: -88% (5% vs 40%)
- **Context resolution**: <50ms
- **Privacy isolation**: 100%

### Compounding Engineering

The context system enables **Compounding Engineering** - each feature makes the next faster:
- **Feature 1**: Baseline
- **Feature 2**: 17% faster
- **Feature 3**: 26% faster
- **Feature 4**: 31% faster
- **Feature 5**: **40% faster** ← Target achieved!

### Documentation

- **Complete Guide**: [docs/THREE_LAYER_CONTEXT_SYSTEM.md](docs/THREE_LAYER_CONTEXT_SYSTEM.md)
- **Framework Impact**: [docs/THREE_LAYER_CONTEXT_FRAMEWORK_IMPACT.md](docs/THREE_LAYER_CONTEXT_FRAMEWORK_IMPACT.md)
- **Implementation Status**: [docs/THREE_LAYER_CONTEXT_COMPLETE.md](docs/THREE_LAYER_CONTEXT_COMPLETE.md)

---

## 🤖 Agent Auto-Activation System

VERSATIL agents automatically activate based on file patterns and context - **no manual slash commands needed** for routine tasks.

### How It Works

```
Edit File → Hook Fires → JSON Suggestion → Claude Invokes Agent via Task Tool
```

**Example**: Edit `LoginForm.test.tsx` → Maria-QA automatically activates for quality validation

### Agent Triggers Quick Reference

| Agent | Auto-Activates On | Priority |
|-------|------------------|----------|
| **Maria-QA** | `*.test.*`, `*.spec.*`, `__tests__/**` | ⚡ High |
| **James-Frontend** | `*.tsx`, `*.jsx`, `*.vue`, `*.css` | 🎨 Medium |
| **Marcus-Backend** | `api/**`, `routes/**`, `*.api.*` | ⚙️ High |
| **Dana-Database** | `*.sql`, `migrations/**`, `*.prisma` | 🗄️ High |
| **Dr.AI-ML** | `ml/**/*.py`, `*.ipynb`, `models/**` | 🤖 Medium |
| **Alex-BA** | `requirements/**`, `*.feature` | 📊 Medium |
| **Sarah-PM** | `*.md`, `docs/**` | 👔 Low |
| **Oliver-MCP** | `mcp/**`, `*.mcp.*` | 🔌 Medium |

### Sub-Agent Routing (Automatic)

When editing backend/frontend code, the framework automatically routes to specialized sub-agents:

**Frontend**: React, Vue, Next.js, Angular, Svelte
**Backend**: Node.js, Python, Rails, Go, Java

**Complete Reference**: [.claude/AGENT_TRIGGERS.md](.claude/AGENT_TRIGGERS.md)

---

## 📚 Library-Specific Context (v6.6.0+)

**Per-Library Rules & Patterns for Precision Development**

Beyond project-wide conventions, VERSATIL supports library-specific context files (`claude.md`) in each major module. These files provide targeted guidance when working with specific parts of the codebase.

### The Four-Layer Context System

```
User Preferences (HIGHEST - ~/.versatil/users/[id]/profile.json)
    ↓
Library Context (NEW - src/[library]/claude.md)
    ↓
Team Conventions (CLAUDE.md, project root)
    ↓
Framework Defaults (LOWEST)
```

**Priority**: When conventions conflict, higher layers always win.

### How It Works

When you edit a file like `src/rag/pattern-search.ts`, the `before-prompt` hook:
1. Detects library from path: `rag`
2. Loads `src/rag/claude.md` if it exists
3. Injects library-specific context into system message
4. Combines with RAG patterns and team conventions

### Library Context Files

Each `claude.md` provides:
- **Purpose**: What the library does (1-2 sentences)
- **Key Concepts**: Core abstractions and patterns
- **Conventions & Rules**: Library-specific coding standards
- **Usage Patterns**: Copy-paste code examples
- **Important Gotchas**: Common mistakes and footguns
- **Related Libraries**: Dependencies and interactions
- **Testing Requirements**: Coverage and test patterns

### Priority Libraries (15 with context files)

| Library | Purpose | Key Pattern |
|---------|---------|-------------|
| **agents/** | OPERA agent definitions | Handoff contracts, role specialization |
| **rag/** | Pattern search & RAG | GraphRAG first, Vector fallback |
| **orchestration/** | Workflow coordination | Phase detection, state persistence |
| **planning/** | Feature planning | CODIFY phase, effort estimation |
| **templates/** | Template matching | 70% threshold, keyword scoring |
| **hooks/** | Event system | Native SDK, hook lifecycle |
| **mcp/** | MCP integration | Server management, protocol |
| **context/** | Context management | Three-layer priority system |
| **intelligence/** | AI/ML features | Adaptive learning |
| **learning/** | Learning system | Codification, feedback loops |
| **memory/** | Memory management | State persistence, caching |
| **testing/** | Test infrastructure | 80%+ coverage, Maria-QA patterns |
| **validation/** | Quality gates | Contract validation, rules |
| **ui/** | UI components | React, accessibility (WCAG 2.1 AA) |
| **dashboard/** | Dashboard features | Charts, visualization |

### Benefits

- **Faster onboarding**: New contributors get library-specific guidance immediately
- **Fewer mistakes**: Common gotchas documented with solutions
- **Consistent patterns**: Everyone follows the same library conventions
- **Precision context**: Only inject rules relevant to current work

### Example: src/rag/claude.md

```markdown
# RAG (Retrieval-Augmented Generation)

## Purpose
Pattern search and historical context retrieval using GraphRAG + Vector stores.

## Key Rule
⚠️ **Always try GraphRAG first** - It's offline and has no API quota

## Common Pattern
\`\`\`typescript
import { patternSearchService } from './pattern-search.js';

const result = await patternSearchService.searchSimilarFeatures({
  description: 'Add user authentication',
  min_similarity: 0.75,
  limit: 5
});
\`\`\`

## Important Gotcha
GraphRAG initialization can fail silently - check `search_method` in result.
```

### Creating New Library Context

When creating a new library or major module:

1. Copy template: `templates/context/library-claude.md.template`
2. Fill in sections based on actual code
3. Include real examples with file:line references
4. Document gotchas from git history/issues
5. Keep under 200 lines (signal over noise)
6. Place in `src/[library]/claude.md`

**Template**: [templates/context/library-claude.md.template](templates/context/library-claude.md.template)
**Audit Report**: [docs/context/LIBRARY_AUDIT_REPORT.md](docs/context/LIBRARY_AUDIT_REPORT.md)

---

## 🔒 Public/Private RAG Architecture (v7.7.0+)

**Zero Data Leaks + 40% More Accurate Planning**

VERSATIL v7.7.0 introduces separated Public and Private RAG stores with intelligent routing, ensuring your proprietary patterns stay private while benefiting from framework best practices.

### Two Separate RAG Stores

```
┌─────────────────────────────────────────────────────────────┐
│                    RAG Router (Intelligent)                  │
│              Private First → Public Fallback                 │
└────────┬─────────────────────────────────────────┬──────────┘
         │                                          │
         ▼                                          ▼
┌──────────────────────┐              ┌──────────────────────┐
│   🔒 Private RAG     │              │   🌍 Public RAG      │
│  (Your Patterns)     │              │ (Framework Patterns) │
├──────────────────────┤              ├──────────────────────┤
│ Backend: YOUR CHOICE │              │ Backend: Firestore   │
│ • Firestore          │              │                      │
│ • Supabase           │              │ Project:             │
│ • Local JSON         │              │ centering-vine-...   │
│                      │              │                      │
│ Patterns:            │              │ Patterns: 1,247      │
│ Company-specific ✅  │              │ React, JWT, etc. ✅  │
│ Client work ✅       │              │                      │
│ Internal APIs ✅     │              │ Edge: Cloud Run      │
│                      │              │ 50-100ms avg         │
│ Privacy: 100% ✅     │              │                      │
└──────────────────────┘              └──────────────────────┘
```

### Key Benefits

| Feature | Public RAG | Private RAG |
|---------|-----------|-------------|
| **Purpose** | Framework patterns for coding excellence | Your proprietary project memory |
| **Storage** | Cloud (managed by VERSATIL) | **Your choice** (Firestore/Supabase/Local) |
| **Data Examples** | React patterns, JWT auth, testing | Company code, client work, internal APIs |
| **Privacy** | Shared framework storage | 100% isolated (never leaves your storage) |
| **Pattern Priority** | Secondary (fallback) | Primary (always ranked first) |
| **Free Tier** | N/A (included) | Firestore (1GB), Supabase (500MB), Local (unlimited) |

### Quick Start

```bash
# 1. Configure Private RAG (one-time setup, 2-3 minutes)
npm run setup:private-rag

# 2. Migrate existing patterns (optional)
npm run migrate:rag --dry-run    # Preview
npm run migrate:rag --force      # Execute

# 3. Verify privacy separation
npm run verify:rag

# 4. Use normally - patterns auto-route to correct store
/plan "Add feature"   # Uses both Private + Public RAG
/learn "Completed"    # Stores in Private RAG (if configured)
/rag status           # View configuration
```

### Storage Selection (/learn command)

When you complete work and run `/learn`, you'll be prompted:

```
Where should these learnings be stored?

1. 🔒 Private RAG (recommended) - Your proprietary patterns, not shared
2. 🌍 Public RAG - Generic framework patterns, helps improve VERSATIL
3. Both - Store in Private (priority) + contribute to Public (if generic)

Choose (1/2/3):
```

**Default**: Private RAG if configured, otherwise Public with setup suggestion

### Pattern Sources in /plan Output

When planning features, you'll see which RAG store patterns came from:

```markdown
## Historical Context

Found 10 similar features

Pattern Sources:
- 🔒 Private patterns: 3 (your proprietary learnings)
- 🌍 Public patterns: 7 (framework best practices)

Top Matches:
1. 🔒 "Company SSO auth workflow" (92% similar) - YOUR pattern
2. 🔒 "Client OAuth2 integration" (88% similar) - YOUR pattern
3. 🌍 "JWT authentication with refresh tokens" (84% similar) - Framework

💡 Tip: Configure Private RAG for even better accuracy!
   Run: npm run setup:private-rag (2 minutes)
```

### RAG Management

```bash
/rag status          # View RAG configuration and health
/rag configure       # Setup Private RAG storage
/rag migrate         # Migrate patterns to Public/Private
/rag verify          # Verify privacy separation
/rag query "auth"    # Test pattern search
/rag stats           # Detailed analytics
```

See `/help rag` for complete documentation.

### Privacy Guarantees

✅ **Zero data leaks** - Private patterns NEVER leave your storage
✅ **100% audit trail** - All pattern storage logged
✅ **Automatic verification** - Daily privacy checks
✅ **User-controlled** - You choose your storage backend

### Documentation

- **Setup Guide**: [docs/guides/PRIVATE_RAG_SETUP.md](docs/guides/PRIVATE_RAG_SETUP.md)
- **Migration Script**: [scripts/migrate-to-public-private.ts](scripts/migrate-to-public-private.ts)
- **Verification**: [scripts/verify-rag-separation.ts](scripts/verify-rag-separation.ts)
- **Management Command**: `/rag` (see `/help rag`)

---
